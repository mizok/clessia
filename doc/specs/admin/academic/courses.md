# 課程列表

> **Self-contained Spec** - 工程師實作時只需讀取此檔案

**路徑**: `/admin/courses`
**角色**: Admin
**分組**: 教務管理

---

## 核心目的

管理補習班的**課程主檔**。課程定義「教什麼」（如國一數學），不涉及「什麼時候上」。

---

## 業務規則

| 規則           | 說明                                                           |
| -------------- | -------------------------------------------------------------- |
| 課程歸屬       | 課程屬於特定分校，不同分校可有同名課程                         |
| 課程 vs 開課班 | 課程是分類層級，開課班才是實際上課單位。一個課程可有多個開課班 |
| 課程名稱       | 同分校內唯一，不可重複                                         |
| 科目分類       | 從系統設定讀取（預設：國文/英文/數學/自然/社會/其他）          |
| 停用限制       | 有「啟用中」的開課班時，僅能停用課程，不可刪除                 |
| 刪除限制       | 只有無任何開課班（含歷史）的課程可刪除                         |

---

## 資料模型

```sql
-- courses 表
id          UUID PRIMARY KEY
org_id      UUID NOT NULL REFERENCES organizations(id)
campus_id   UUID NOT NULL REFERENCES campuses(id)  -- 所屬分校
name        TEXT NOT NULL           -- 課程名稱，如「國一數學」
subject     TEXT NOT NULL           -- 科目，參照系統設定
description TEXT                    -- 課程說明
is_active   BOOLEAN DEFAULT true    -- 啟用/停用
created_at  TIMESTAMPTZ
updated_at  TIMESTAMPTZ

-- 唯一約束（同分校內名稱唯一）
UNIQUE(campus_id, name)
```

**關聯查詢**：

```sql
-- 列表查詢（含分校名稱）
SELECT c.*, cp.name as campus_name
FROM courses c
JOIN campuses cp ON cp.id = c.campus_id
WHERE c.org_id = :org_id
```

---

## UI 規格

### 頁面結構

```
┌─────────────────────────────────────────────────┐
│  課程管理                        [+ 新增課程]   │
├─────────────────────────────────────────────────┤
│  🔍 搜尋課程名稱  [分校 ▼]  [科目 ▼]  [狀態 ▼] │
├─────────────────────────────────────────────────┤
│  ┌─────────┬──────┬──────┬──────┬────────┐     │
│  │ 課程名稱 │ 分校 │ 科目 │ 狀態 │  操作  │     │
│  ├─────────┼──────┼──────┼──────┼────────┤     │
│  │ 國一數學 │ 本校 │ 數學 │ 啟用 │ ⋮ 編輯 │     │
│  │ 國一英文 │ 本校 │ 英文 │ 啟用 │ ⋮ 編輯 │     │
│  │ 國二數學 │ 二校 │ 數學 │ 停用 │ ⋮ 刪除 │     │
│  └─────────┴──────┴──────┴──────┴────────┘     │
│                              [< 1 2 3 ... >]    │
└─────────────────────────────────────────────────┘
```

### 列表欄位

| 欄位     | 說明                           |
| -------- | ------------------------------ |
| 課程名稱 | 主要識別，可點擊進入編輯       |
| 分校     | 課程所屬分校                   |
| 科目     | 分類標籤                       |
| 狀態     | `啟用`（綠色）/ `停用`（灰色） |
| 操作     | 編輯、刪除（條件顯示）         |

### 篩選功能

- **搜尋**：課程名稱模糊搜尋
- **分校**：下拉選單，單選（有多分校時顯示）
- **科目**：下拉多選，從系統設定讀取
- **狀態**：全部 / 啟用 / 停用

### 新增/編輯 Dialog

| 欄位     | 類型        | 必填 | 驗證規則                 |
| -------- | ----------- | ---- | ------------------------ |
| 分校     | Dropdown    | ✅   | 從使用者可管理的分校讀取 |
| 課程名稱 | InputText   | ✅   | 1-50 字元，同分校內唯一  |
| 科目     | Dropdown    | ✅   | 從系統設定讀取選項       |
| 說明     | Textarea    |      | 最多 500 字元            |
| 狀態     | InputSwitch | ✅   | 預設啟用                 |

### 空狀態

- 無課程時：「尚未建立任何課程」+ 新增按鈕
- 篩選無結果時：「找不到符合條件的課程」

### 錯誤處理

| 情境               | 訊息                               |
| ------------------ | ---------------------------------- |
| 名稱重複           | 「此分校已有同名課程」             |
| 刪除有開課班的課程 | 「此課程有 N 個開課班，無法刪除」  |
| 無分校權限         | 「您沒有該分校的管理權限」         |
| 網路錯誤           | Toast 提示「操作失敗，請稍後再試」 |

---

## API 端點

| 方法   | 路徑                                       | 說明                     |
| ------ | ------------------------------------------ | ------------------------ |
| GET    | `/rest/v1/courses?select=*,campuses(name)` | 列表（含分校名稱）       |
| GET    | `/rest/v1/courses?campus_id=eq.{id}`       | 依分校篩選               |
| POST   | `/rest/v1/courses`                         | 新增（需帶 campus_id）   |
| PATCH  | `/rest/v1/courses?id=eq.{id}`              | 更新（campus_id 不可改） |
| DELETE | `/rest/v1/courses?id=eq.{id}`              | 刪除（需檢查無開課班）   |

**RLS 規則**：

- 讀取：同組織成員可讀
- 寫入：需 `manage_courses` 權限 + 該分校管理權限

---

## 組件結構（建議）

```
src/app/features/admin/pages/courses/
├── courses-page.component.ts      # 主頁面（Smart Component）
├── courses-page.component.html
├── courses-page.component.scss
├── course-dialog.component.ts     # 新增/編輯 Dialog
├── course-dialog.component.html
└── course.service.ts              # 資料存取層
```

**使用的 PrimeNG 元件**：

- `p-table` - 列表
- `p-dialog` - 新增/編輯彈窗
- `p-dropdown` - 科目選擇
- `p-inputSwitch` - 狀態切換
- `p-confirmDialog` - 刪除確認

---

## 驗收標準

### 功能驗收

- [ ] 可檢視課程列表，顯示名稱、分校、科目、狀態
- [ ] 可依名稱搜尋、依分校/科目/狀態篩選
- [ ] 可新增課程，同分校名稱重複時顯示錯誤
- [ ] 可編輯課程資訊（分校不可變更）
- [ ] 可切換課程啟用/停用狀態
- [ ] 無開課班的課程可刪除，有開課班時禁止刪除並提示
- [ ] 列表支援分頁（每頁 20 筆）

### 技術驗收

- [ ] 使用 Signals 管理狀態
- [ ] 使用 Supabase RLS 控制權限
- [ ] Dialog 使用 Reactive Forms + 驗證
- [ ] 有 Loading 狀態顯示
- [ ] 錯誤處理完整（網路錯誤、業務錯誤）

---

## 相關頁面

- `/admin/classes` - 課程管理（子層級）
- `/admin/campuses` - 分校管理（分校來源）
- `/admin/settings` - 系統設定（科目清單來源）
