<p-toast />
<p-confirmDialog />

<div class="classes">
  <!-- Page Header -->
  <header class="classes__header">
    <div class="classes__title-group">
      <h1 class="classes__title">{{ page().label }}</h1>
      <p class="classes__subtitle">層級管理課程與班級，設定上課時間</p>
    </div>
    <div class="classes__header-actions">
      <p-button
        label="操作紀錄"
        icon="pi pi-history"
        [outlined]="true"
        severity="secondary"
        (onClick)="auditLogVisible.set(true)"
      />
      <p-button label="新增課程" icon="pi pi-plus" (onClick)="openCreateCourseDialog()" />
    </div>
  </header>

  <!-- Filter Bar -->
  <div class="classes__card">
    @if (campuses().length > 1) {
      <p-tabs
        [value]="selectedCampusId() ?? 'all'"
        (valueChange)="onCampusTabChange($event)"
        styleClass="classes__campus-tabs"
      >
        <p-tablist>
          <p-tab value="all">全部</p-tab>
          @for (campus of campuses(); track campus.id) {
            <p-tab [value]="campus.id">{{ campus.name }}</p-tab>
          }
        </p-tablist>
      </p-tabs>
    }
    <div class="classes__toolbar">
      <label class="classes__select-all" pTooltip="全選 / 取消全選" tooltipPosition="top">
        <input
          type="checkbox"
          class="batch-checkbox"
          [checked]="allVisibleSelected()"
          [indeterminate]="selectedClassIds().size > 0 && !allVisibleSelected()"
          (change)="toggleSelectAll()"
        />
      </label>

      <div class="classes__search">
        <p-iconField iconPosition="left">
          <p-inputIcon styleClass="pi pi-search" />
          <input
            type="text"
            pInputText
            placeholder="搜尋課程或班級..."
            [ngModel]="searchQuery()"
            (ngModelChange)="searchQuery.set($event)"
          />
        </p-iconField>
      </div>

      <div class="classes__filters">
        <p-select
          [options]="subjectOptions()"
          [ngModel]="selectedSubjectId()"
          (ngModelChange)="selectedSubjectId.set($event)"
          placeholder="所有科目"
          [showClear]="true"
          styleClass="classes__filter-select"
          appendTo="body"
        />
        <p-multiselect
          [options]="staffOptions()"
          [ngModel]="selectedTeacherIds()"
          (ngModelChange)="selectedTeacherIds.set($event)"
          placeholder="所有老師"
          selectedItemsLabel="{0} 位老師"
          [filter]="true"
          filterPlaceholder="搜尋老師..."
          styleClass="classes__filter-select"
          appendTo="body"
        />
        <p-select
          [options]="statusOptions"
          [ngModel]="statusFilter()"
          (ngModelChange)="statusFilter.set($event)"
          placeholder="全部狀態"
          styleClass="classes__filter-select"
          appendTo="body"
        />
      </div>

      <p-button
        [label]="showInactiveCourses() ? '隱藏停用課程' : '顯示停用課程'"
        [icon]="showInactiveCourses() ? 'pi pi-eye-slash' : 'pi pi-eye'"
        [text]="true"
        size="small"
        severity="secondary"
        (onClick)="showInactiveCourses.set(!showInactiveCourses())"
      />

      @if (hasActiveFilters()) {
        <p-button
          label="清除"
          icon="pi pi-filter-slash"
          [text]="true"
          severity="secondary"
          (onClick)="clearFilters()"
        />
      }
    </div>

    <!-- Content -->
    <div class="classes__content">
      @if (loading()) {
        <!-- Skeleton -->
        <div class="skeleton-list">
          @for (group of [1, 2, 3]; track group) {
            <span class="skeleton-bar skeleton-bar--label"></span>
            <span class="skeleton-bar"></span>
            <span class="skeleton-bar"></span>
          }
        </div>
      } @else if (courseGroups().length === 0) {
        <!-- Empty State -->
        @if (hasActiveFilters()) {
          <app-empty-state
            icon="pi pi-filter-slash"
            title="找不到符合條件的課程或班級"
            description="試試調整搜尋關鍵字或篩選條件"
          >
            <p-button
              label="清除篩選"
              icon="pi pi-filter-slash"
              [outlined]="true"
              severity="secondary"
              (onClick)="clearFilters()"
            />
          </app-empty-state>
        } @else {
          <app-empty-state
            icon="pi pi-book"
            title="尚未建立任何課程"
            description="點擊右上角「新增課程」開始建立課程與班級"
          >
            <p-button label="新增課程" icon="pi pi-plus" (onClick)="openCreateCourseDialog()" />
          </app-empty-state>
        }
      } @else {
        <!-- Course Groups -->
        <div class="classes__groups">
          @for (group of courseGroups(); track group.course.id) {
            <div class="course-group">
              <!-- Course Header -->
              <div
                class="course-group__header"
                role="button"
                tabindex="0"
                [attr.aria-expanded]="!isCourseCollapsed(group.course.id)"
                (click)="toggleCourse(group.course.id)"
                (keydown.enter)="toggleCourse(group.course.id)"
                (keydown.space)="$event.preventDefault(); toggleCourse(group.course.id)"
              >
                <div class="course-group__info">
                  <div class="course-group__name-row">
                    <i
                      class="pi course-group__chevron"
                      [class.pi-chevron-down]="!isCourseCollapsed(group.course.id)"
                      [class.pi-chevron-right]="isCourseCollapsed(group.course.id)"
                    ></i>
                    <i class="pi pi-book course-group__icon"></i>
                    <span class="course-group__name">{{ group.course.name }}</span>
                    <span class="course-group__campus">{{
                      group.course.campusName ?? getCampusName(group.course.campusId)
                    }}</span>
                    <p-tag [value]="group.course.subjectName" severity="info" />
                    @if (!group.course.isActive) {
                      <p-tag value="已停用" severity="secondary" />
                    }
                  </div>
                  <span class="course-group__count">{{ group.classes.length }} 個班</span>
                </div>
                <div class="course-group__actions" (click)="$event.stopPropagation()">
                  <p-button
                    label="新增班"
                    icon="pi pi-plus"
                    size="small"
                    [outlined]="true"
                    severity="secondary"
                    [disabled]="!group.course.isActive"
                    [pTooltip]="!group.course.isActive ? '課程已停用，無法新增班級' : ''"
                    tooltipPosition="top"
                    (onClick)="openCreateClassDialog(group.course.id)"
                  />
                  <p-button
                    icon="pi pi-pencil"
                    [rounded]="true"
                    [text]="true"
                    severity="secondary"
                    size="small"
                    pTooltip="編輯課程"
                    tooltipPosition="top"
                    (onClick)="openEditCourseDialog(group.course)"
                  />
                  <p-button
                    icon="pi pi-trash"
                    [rounded]="true"
                    [text]="true"
                    severity="danger"
                    size="small"
                    pTooltip="刪除課程"
                    tooltipPosition="top"
                    (onClick)="confirmDeleteCourse(group.course)"
                  />
                </div>
              </div>

              <!-- Classes List -->
              <div
                class="course-group__classes"
                [class.course-group__classes--collapsed]="isCourseCollapsed(group.course.id)"
              >
                <div class="course-group__classes-inner">
                  @for (cls of group.classes; track cls.id) {
                    <div class="class-row" [class.class-row--expanded]="isExpanded(cls.id)">
                      <!-- Summary Row (clickable) -->
                      <div
                        class="class-row__summary"
                        [class.class-row__summary--selected]="selectedClassIds().has(cls.id)"
                        (click)="toggleExpand(cls.id)"
                        role="button"
                        tabindex="0"
                        (keydown.enter)="toggleExpand(cls.id)"
                      >
                        <input
                          type="checkbox"
                          class="batch-checkbox"
                          [checked]="selectedClassIds().has(cls.id)"
                          (change)="toggleClassSelection(cls.id, $event)"
                          (click)="$event.stopPropagation()"
                        />
                        <i
                          class="pi class-row__chevron"
                          [class.pi-chevron-right]="!isExpanded(cls.id)"
                          [class.pi-chevron-down]="isExpanded(cls.id)"
                        ></i>
                        <span class="class-row__name">{{ cls.name }}</span>
                        <span class="class-row__schedules">
                          @if (cls.schedules && cls.schedules.length > 0) {
                            <i class="pi pi-clock"></i>
                            {{ getScheduleSummary(cls.schedules) }}
                          } @else {
                            <span class="class-row__no-schedule">尚無時間表</span>
                          }
                        </span>
                        @if (cls.maxStudents) {
                          <span class="class-row__capacity">
                            <i class="pi pi-users"></i>
                            {{ cls.maxStudents }}
                          </span>
                        }
                        <div class="class-row__tags">
                          <p-tag
                            [value]="cls.isActive ? '啟用中' : '停用中'"
                            [severity]="cls.isActive ? 'success' : 'secondary'"
                          />
                          @if (cls.scheduleCount === 0) {
                            <span
                              class="class-row__completeness-warn"
                              pTooltip="尚未設定上課時間"
                              tooltipPosition="top"
                            >
                              <i class="pi pi-exclamation-triangle"></i>
                              無時段
                            </span>
                          } @else if (cls.isActive && !cls.hasUpcomingSessions) {
                            <span
                              class="class-row__completeness-info"
                              pTooltip="尚未產生未來課堂"
                              tooltipPosition="top"
                            >
                              <i class="pi pi-calendar-plus"></i>
                              未排課
                            </span>
                          }
                        </div>
                      </div>

                      <!-- Expanded Detail -->
                      <div
                        class="class-row__detail-wrap"
                        [class.class-row__detail-wrap--hidden]="!isExpanded(cls.id)"
                      >
                        <div class="class-row__detail">
                          <!-- Schedules -->
                          <div class="class-detail__section">
                            <div class="class-detail__section-title">
                              <i class="pi pi-clock"></i>
                              上課時間
                            </div>
                            @if (cls.schedules && cls.schedules.length > 0) {
                              <div class="class-detail__schedules">
                                @for (s of cls.schedules; track s.id) {
                                  <div class="schedule-badge">
                                    <span class="schedule-badge__day">{{
                                      getWeekdayLabel(s.weekday)
                                    }}</span>
                                    <span class="schedule-badge__time"
                                      >{{ s.startTime.substring(0, 5) }}-{{
                                        s.endTime.substring(0, 5)
                                      }}</span
                                    >
                                    @if (s.teacherName) {
                                      <span class="schedule-badge__teacher">
                                        <i class="pi pi-user"></i>
                                        {{ s.teacherName }}
                                      </span>
                                    }
                                    <span class="schedule-badge__from"
                                      >起: {{ s.effectiveFrom }}</span
                                    >
                                  </div>
                                }
                              </div>
                            } @else {
                              <p class="class-detail__empty">尚未設定上課時間</p>
                            }
                          </div>

                          <!-- Grade Levels -->
                          @if (cls.gradeLevels && cls.gradeLevels.length > 0) {
                            <div class="class-detail__section">
                              <div class="class-detail__section-title">
                                <i class="pi pi-graduation-cap"></i>
                                適合年級
                              </div>
                              <div class="class-detail__grades">
                                @for (grade of cls.gradeLevels; track grade) {
                                  <span class="grade-chip">{{ grade }}</span>
                                }
                              </div>
                            </div>
                          }

                          <!-- Audit Info -->
                          <div class="class-detail__audit">
                            <i class="pi pi-history"></i>
                            @if (cls.updatedByName) {
                              最後由 <strong>{{ cls.updatedByName }}</strong> 修改於 {{ cls.updatedAt | date:'yyyy-MM-dd HH:mm:ss' }}
                            } @else {
                              最後修改：{{ cls.updatedAt | date:'yyyy-MM-dd HH:mm:ss' }}
                            }
                          </div>

                          <!-- Actions -->
                          <div class="class-detail__actions">
                            <p-button
                              label="編輯班級"
                              icon="pi pi-pencil"
                              size="small"
                              [outlined]="true"
                              severity="secondary"
                              (onClick)="openEditClassDialog(cls)"
                            />
                            <p-button
                              label="產生課堂"
                              icon="pi pi-calendar-plus"
                              size="small"
                              [outlined]="true"
                              severity="info"
                              (onClick)="openGenerateDialog(cls)"
                            />
                            <p-button
                              [label]="cls.isActive ? '停用' : '啟用'"
                              [icon]="cls.isActive ? 'pi pi-ban' : 'pi pi-check-circle'"
                              size="small"
                              [outlined]="true"
                              [severity]="cls.isActive ? 'secondary' : 'success'"
                              (onClick)="confirmToggleActive(cls)"
                            />
                            <p-button
                              label="刪除"
                              icon="pi pi-trash"
                              size="small"
                              [outlined]="true"
                              severity="danger"
                              (onClick)="confirmDeleteClass(cls)"
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  } @empty {
                    <div class="course-group__empty">此課程尚無班級，點擊「新增班」建立</div>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>

    <!-- Batch Action Bar -->
    @if (selectedClassIds().size > 0) {
      <div class="classes__batch-bar">
        <span class="classes__batch-count">已選 {{ selectedClassIds().size }} 個班級</span>
        <div class="classes__batch-actions">
          @if (selectedInactiveCount() > 0) {
            <p-button
              [label]="'啟用 ' + selectedInactiveCount() + ' 個'"
              icon="pi pi-check-circle"
              size="small"
              severity="success"
              [outlined]="true"
              (onClick)="batchActivate()"
            />
          }
          @if (selectedActiveCount() > 0) {
            <p-button
              [label]="'停用 ' + selectedActiveCount() + ' 個'"
              icon="pi pi-ban"
              size="small"
              severity="secondary"
              [outlined]="true"
              (onClick)="batchDeactivate()"
            />
          }
          <p-button
            [label]="'刪除 ' + selectedClassIds().size + ' 個'"
            icon="pi pi-trash"
            size="small"
            severity="danger"
            [outlined]="true"
            (onClick)="batchDelete()"
          />
          <p-button
            label="取消選取"
            icon="pi pi-times"
            size="small"
            [text]="true"
            severity="secondary"
            (onClick)="clearSelection()"
          />
        </div>
      </div>
    }
  </div>
</div>

<!-- ============================================================ -->
<!-- Course Dialog -->
<!-- ============================================================ -->
<p-dialog
  [header]="courseDialogTitle()"
  [(visible)]="courseDialogVisible"
  [modal]="true"
  [closable]="!courseDialogLoading()"
  [style]="{ width: '32rem' }"
>
  <div class="form-dialog">
    <!-- Campus (create only) -->
    @if (courseDialogMode() === 'create') {
      <div class="form-dialog__field">
        <label class="form-dialog__label"> 分校<span class="form-dialog__required">*</span> </label>
        <p-select
          [options]="campusOptions()"
          [ngModel]="courseForm().campusId"
          (ngModelChange)="updateCourseForm('campusId', $event)"
          placeholder="選擇分校"
          [disabled]="courseDialogLoading()"
          styleClass="w-full"
          appendTo="body"
        />
      </div>
    }

    <!-- Name -->
    <div class="form-dialog__field">
      <label class="form-dialog__label">
        課程名稱<span class="form-dialog__required">*</span>
      </label>
      <input
        type="text"
        pInputText
        [ngModel]="courseForm().name"
        (ngModelChange)="updateCourseForm('name', $event)"
        placeholder="例如：國一數學"
        [disabled]="courseDialogLoading()"
        class="w-full"
      />
    </div>

    <!-- Subject -->
    <div class="form-dialog__field">
      <label class="form-dialog__label"> 科目<span class="form-dialog__required">*</span> </label>
      <p-select
        [options]="subjectOptions()"
        [ngModel]="courseForm().subjectId"
        (ngModelChange)="updateCourseForm('subjectId', $event)"
        placeholder="選擇科目"
        [disabled]="courseDialogLoading()"
        styleClass="w-full"
        appendTo="body"
      />
    </div>

    <!-- Description -->
    <div class="form-dialog__field">
      <label class="form-dialog__label">說明（選填）</label>
      <input
        type="text"
        pInputText
        [ngModel]="courseForm().description"
        (ngModelChange)="updateCourseForm('description', $event)"
        placeholder="課程說明"
        [disabled]="courseDialogLoading()"
        class="w-full"
      />
    </div>

    <!-- Status (edit only) -->
    @if (courseDialogMode() === 'edit') {
      <div class="form-dialog__field form-dialog__field--inline">
        <label class="form-dialog__label">狀態</label>
        <div class="form-dialog__switch-row">
          <p-toggleswitch
            [ngModel]="courseForm().isActive"
            (ngModelChange)="updateCourseForm('isActive', $event)"
            [disabled]="courseDialogLoading()"
          />
          <span class="form-dialog__switch-label">
            {{ courseForm().isActive ? '啟用中' : '已停用' }}
          </span>
        </div>
      </div>
      @if (!courseForm().isActive && editingCourseActiveClassCount() > 0) {
        <div class="form-dialog__warning">
          <i class="pi pi-info-circle"></i>
          此課程下有
          {{
            editingCourseActiveClassCount()
          }}
          個啟用班級，停用後不影響現有班級運作，但無法新增新班級。
        </div>
      }
    }

    <!-- Footer -->
    <div class="form-dialog__footer">
      <p-button
        label="取消"
        [text]="true"
        severity="secondary"
        [disabled]="courseDialogLoading()"
        (onClick)="courseDialogVisible.set(false)"
      />
      <p-button
        [label]="courseDialogMode() === 'create' ? '建立' : '儲存'"
        [icon]="courseDialogLoading() ? 'pi pi-spinner pi-spin' : 'pi pi-check'"
        [loading]="courseDialogLoading()"
        (onClick)="saveCourse()"
        [disabled]="!courseForm().name.trim() || !courseForm().subjectId"
      />
    </div>
  </div>
</p-dialog>

<!-- ============================================================ -->
<!-- Class Dialog -->
<!-- ============================================================ -->
<p-dialog
  [header]="classDialogTitle()"
  [(visible)]="classDialogVisible"
  [modal]="true"
  [closable]="!classDialogLoading()"
  [style]="{ width: '44rem' }"
>
  <div class="form-dialog">
    <!-- Name -->
    <div class="form-dialog__field">
      <label class="form-dialog__label">
        班級名稱<span class="form-dialog__required">*</span>
      </label>
      <input
        type="text"
        pInputText
        [ngModel]="classForm().name"
        (ngModelChange)="updateClassForm('name', $event)"
        placeholder="例如：A 班（週六上午）"
        [disabled]="classDialogLoading()"
        class="w-full"
      />
    </div>

    <!-- Max Students -->
    <div class="form-dialog__field">
      <label class="form-dialog__label">人數上限</label>
      <p-inputnumber
        [ngModel]="classForm().maxStudents"
        (ngModelChange)="updateClassForm('maxStudents', $event)"
        [min]="1"
        [max]="200"
        [disabled]="classDialogLoading()"
        styleClass="w-full"
      />
    </div>

    <!-- Grade Levels -->
    <div class="form-dialog__field">
      <label class="form-dialog__label">適合年級（選填）</label>
      <p-multiselect
        [options]="gradeOptions"
        [ngModel]="classForm().gradeLevels"
        (ngModelChange)="updateClassForm('gradeLevels', $event)"
        placeholder="選擇適合年級"
        [disabled]="classDialogLoading()"
        styleClass="w-full"
        appendTo="body"
      />
    </div>

    <!-- Status (edit only) -->
    @if (classDialogMode() === 'edit') {
      <div class="form-dialog__field form-dialog__field--inline">
        <label class="form-dialog__label">狀態</label>
        <div class="form-dialog__switch-row">
          <p-toggleswitch
            [ngModel]="classForm().isActive"
            (ngModelChange)="updateClassForm('isActive', $event)"
            [disabled]="classDialogLoading()"
          />
          <span class="form-dialog__switch-label">
            {{ classForm().isActive ? '啟用中' : '已停用' }}
          </span>
        </div>
      </div>
    }

    <!-- Schedules Section -->
    <div class="form-dialog__section">
      <div class="form-dialog__section-header">
        <span class="form-dialog__section-title">
          <i class="pi pi-clock"></i>
          上課時間
        </span>
        <p-button
          label="新增時段"
          icon="pi pi-plus"
          [text]="true"
          size="small"
          (onClick)="addScheduleEntry()"
          [disabled]="classDialogLoading()"
        />
      </div>

      @if (scheduleEntries().length === 0) {
        <p class="form-dialog__empty-note">尚未設定上課時間，點擊「新增時段」添加</p>
      } @else {
        <div class="schedule-entries">
          @for (entry of scheduleEntries(); track $index) {
            <div class="schedule-entry">
              <div class="schedule-entry__row">
                <!-- Weekday -->
                <p-select
                  [options]="weekdayOptions"
                  [ngModel]="entry.weekday"
                  (ngModelChange)="updateScheduleEntry($index, 'weekday', $event)"
                  placeholder="星期"
                  [disabled]="classDialogLoading()"
                  styleClass="schedule-entry__weekday"
                  appendTo="body"
                />
                <!-- Start Time -->
                <input
                  type="time"
                  class="schedule-entry__time-input"
                  [ngModel]="entry.startTime"
                  (ngModelChange)="updateScheduleEntry($index, 'startTime', $event)"
                  [disabled]="classDialogLoading()"
                />
                <span class="schedule-entry__dash">—</span>
                <!-- End Time -->
                <input
                  type="time"
                  class="schedule-entry__time-input"
                  [ngModel]="entry.endTime"
                  (ngModelChange)="updateScheduleEntry($index, 'endTime', $event)"
                  [disabled]="classDialogLoading()"
                />
                <!-- Remove -->
                <p-button
                  icon="pi pi-times"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  size="small"
                  (onClick)="removeScheduleEntry($index)"
                  [disabled]="classDialogLoading()"
                />
              </div>
              <div class="schedule-entry__row schedule-entry__row--meta">
                <!-- Teacher -->
                <p-select
                  [options]="filteredStaffOptions()"
                  [ngModel]="entry.teacherId"
                  (ngModelChange)="updateScheduleEntry($index, 'teacherId', $event)"
                  placeholder="待指派（選填）"
                  [showClear]="true"
                  [disabled]="classDialogLoading()"
                  styleClass="schedule-entry__teacher"
                  appendTo="body"
                />
                <!-- Effective From -->
                <div class="schedule-entry__effective">
                  <label class="schedule-entry__meta-label">起始日期</label>
                  <input
                    type="date"
                    class="schedule-entry__date-input"
                    [ngModel]="entry.effectiveFrom"
                    (ngModelChange)="updateScheduleEntry($index, 'effectiveFrom', $event)"
                    [disabled]="classDialogLoading()"
                  />
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>

    <!-- Footer -->
    <div class="form-dialog__footer">
      <p-button
        label="取消"
        [text]="true"
        severity="secondary"
        [disabled]="classDialogLoading()"
        (onClick)="classDialogVisible.set(false)"
      />
      <p-button
        [label]="classDialogMode() === 'create' ? '建立' : '儲存'"
        [icon]="classDialogLoading() ? 'pi pi-spinner pi-spin' : 'pi pi-check'"
        [loading]="classDialogLoading()"
        (onClick)="saveClass()"
        [disabled]="!classForm().name.trim()"
      />
    </div>
  </div>
</p-dialog>

<!-- ============================================================ -->
<!-- Generate Sessions Dialog -->
<!-- ============================================================ -->
<p-dialog
  header="產生課堂"
  [(visible)]="generateDialogVisible"
  [modal]="true"
  [closable]="!generateLoading()"
  [style]="{ width: '40rem' }"
  (onHide)="generateStep.set('input')"
>
  @if (generateStep() === 'input') {
    <div class="form-dialog">
      @if (generateTargetClass()) {
        <div class="generate-info">
          <i class="pi pi-info-circle"></i>
          <span
            >班級：<strong>{{ generateTargetClass()!.name }}</strong></span
          >
        </div>
      }
      <p class="generate-hint">選擇日期範圍，系統將依照上課時間表批次產生課堂記錄。</p>

      <div class="form-dialog__row">
        <div class="form-dialog__field">
          <label class="form-dialog__label"
            >開始日期<span class="form-dialog__required">*</span></label
          >
          <p-datepicker
            [ngModel]="generateFrom()"
            (ngModelChange)="generateFrom.set($event)"
            dateFormat="yy-mm-dd"
            [showIcon]="true"
            placeholder="選擇日期"
            styleClass="w-full"
            appendTo="body"
          />
        </div>
        <div class="form-dialog__field">
          <label class="form-dialog__label"
            >結束日期<span class="form-dialog__required">*</span></label
          >
          <p-datepicker
            [ngModel]="generateTo()"
            (ngModelChange)="generateTo.set($event)"
            dateFormat="yy-mm-dd"
            [showIcon]="true"
            placeholder="選擇日期"
            styleClass="w-full"
            appendTo="body"
          />
        </div>
      </div>

      <div class="form-dialog__field">
        <label class="form-dialog__label">排除日期（選填）</label>
        <p-datepicker
          [ngModel]="generateExcludeDates()"
          (ngModelChange)="generateExcludeDates.set($event)"
          selectionMode="multiple"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          placeholder="選擇要排除的日期（可多選）"
          styleClass="w-full"
          appendTo="body"
        />
        @if (generateExcludeDates().length > 0) {
          <span class="generate-exclude-hint">已排除 {{ generateExcludeDates().length }} 個日期</span>
        }
      </div>

      <div class="form-dialog__footer">
        <p-button
          label="取消"
          [text]="true"
          severity="secondary"
          [disabled]="generateLoading()"
          (onClick)="generateDialogVisible.set(false)"
        />
        <p-button
          label="預覽課堂"
          icon="pi pi-eye"
          [loading]="generateLoading()"
          [disabled]="!generateFrom() || !generateTo()"
          (onClick)="previewSessionsAction()"
        />
      </div>
    </div>
  } @else {
    <!-- Preview Step -->
    <div class="generate-preview">
      <div class="generate-preview__summary">
        <span class="generate-preview__total">共 {{ previewSessions().length }} 筆</span>
        <span class="generate-preview__new">新增：{{ newSessionCount() }}</span>
        <span class="generate-preview__skip">略過（已存在）：{{ skippedSessionCount() }}</span>
        @if (generateExcludeDates().length > 0) {
          <span class="generate-preview__excluded">已排除 {{ generateExcludeDates().length }} 個日期</span>
        }
      </div>

      @if (previewSessions().length === 0) {
        <div class="generate-preview__empty">
          <i class="pi pi-calendar-times"></i>
          <p>在此日期範圍內沒有符合時間表的課堂</p>
        </div>
      } @else {
        <div class="generate-preview__table-wrap">
          <table class="generate-preview__table">
            <thead>
              <tr>
                <th>日期</th>
                <th>星期</th>
                <th>時間</th>
                <th>老師</th>
                <th>狀態</th>
              </tr>
            </thead>
            <tbody>
              @for (s of previewSessions(); track s.sessionDate + s.startTime) {
                <tr [class.generate-preview__row--exists]="s.exists">
                  <td>{{ s.sessionDate }}</td>
                  <td>{{ getWeekdayLabel(s.weekday) }}</td>
                  <td>{{ s.startTime.substring(0, 5) }}-{{ s.endTime.substring(0, 5) }}</td>
                  <td>{{ s.teacherName ?? '—' }}</td>
                  <td>
                    @if (s.exists) {
                      <span class="generate-preview__badge generate-preview__badge--skip"
                        >已存在</span
                      >
                    } @else {
                      <span class="generate-preview__badge generate-preview__badge--new"
                        >將新增</span
                      >
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }

      <div class="form-dialog__footer">
        <p-button
          label="返回修改"
          icon="pi pi-arrow-left"
          [text]="true"
          severity="secondary"
          [disabled]="generateLoading()"
          (onClick)="generateStep.set('input')"
        />
        <p-button
          label="確認建立"
          icon="pi pi-check"
          [loading]="generateLoading()"
          [disabled]="newSessionCount() === 0"
          (onClick)="confirmGenerateSessions()"
        />
      </div>
    </div>
  }
</p-dialog>

<!-- ============================================================ -->
<!-- Schedule Conflict Warning Dialog -->
<!-- ============================================================ -->
<p-dialog
  header="排課衝突警告"
  [(visible)]="conflictDialogVisible"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '36rem' }"
>
  <div class="form-dialog">
    <div class="conflict-dialog__header">
      <i class="pi pi-exclamation-triangle conflict-dialog__icon"></i>
      <p class="conflict-dialog__message">
        以下老師在指定時間已有其他班級的排課，存在時段衝突：
      </p>
    </div>

    <div class="conflict-dialog__list">
      @for (conflict of pendingConflicts(); track $index) {
        <div class="conflict-item">
          <div class="conflict-item__teacher">
            <i class="pi pi-user"></i>
            <strong>{{ conflict.teacherName }}</strong>
          </div>
          <div class="conflict-item__detail">
            <span class="conflict-item__class">
              {{ conflict.conflictingCourseName }} / {{ conflict.conflictingClassName }}
            </span>
            <span class="conflict-item__time">
              {{ getWeekdayLabel(conflict.conflictingWeekday) }}
              {{ conflict.conflictingStartTime.substring(0, 5) }}–{{ conflict.conflictingEndTime.substring(0, 5) }}
            </span>
          </div>
        </div>
      }
    </div>

    <p class="conflict-dialog__hint">你可以返回修改時段，或選擇忽略衝突直接儲存。</p>

    <div class="form-dialog__footer">
      <p-button
        label="返回修改"
        icon="pi pi-arrow-left"
        [text]="true"
        severity="secondary"
        (onClick)="conflictDialogVisible.set(false)"
      />
      <p-button
        label="仍要儲存"
        icon="pi pi-check"
        severity="warn"
        (onClick)="proceedSaveDespiteConflicts()"
      />
    </div>
  </div>
</p-dialog>

<!-- ============================================================ -->
<!-- Deactivate Class Dialog -->
<!-- ============================================================ -->
<p-dialog
  header="停用班級"
  [(visible)]="deactivateDialogVisible"
  [modal]="true"
  [closable]="!deactivateLoading()"
  [style]="{ width: '28rem' }"
>
  @if (deactivateTargetClass()) {
    <div class="form-dialog">
      <div class="deactivate-dialog__body">
        <i class="pi pi-ban deactivate-dialog__icon"></i>
        <p class="deactivate-dialog__message">
          確定要停用班級「<strong>{{ deactivateTargetClass()!.name }}</strong
          >」嗎？
        </p>
        <p class="deactivate-dialog__hint">停用後將無法新增學生報名，也無法產生新課堂。</p>
      </div>

      <div class="form-dialog__footer form-dialog__footer--column">
        <p-button
          label="停用並取消所有未來課堂"
          icon="pi pi-calendar-times"
          severity="danger"
          [loading]="deactivateLoading()"
          (onClick)="deactivateAndCancelSessions()"
          styleClass="w-full"
        />
        <p-button
          label="僅停用（保留已排課堂）"
          icon="pi pi-ban"
          [outlined]="true"
          severity="secondary"
          [loading]="deactivateLoading()"
          (onClick)="deactivateOnly()"
          styleClass="w-full"
        />
        <p-button
          label="取消"
          [text]="true"
          severity="secondary"
          [disabled]="deactivateLoading()"
          (onClick)="deactivateDialogVisible.set(false)"
          styleClass="w-full"
        />
      </div>
    </div>
  }
</p-dialog>

<app-audit-log-dialog
  [(visible)]="auditLogVisible"
  [resourceTypes]="['class', 'course']"
  title="課程管理操作紀錄"
/>
