{
  "version": 3,
  "sources": ["apps/web/src/app/core/auth.service.ts"],
  "sourcesContent": ["import { Injectable, signal, computed } from '@angular/core';\nimport { Router } from '@angular/router';\nimport type { User } from '@supabase/supabase-js';\nimport { SupabaseService } from './supabase.service';\n\nexport type UserRole = 'admin' | 'teacher' | 'parent';\n\nexport interface Profile {\n  id: string;\n  display_name: string;\n  branch_id: string | null;\n}\n\n@Injectable({ providedIn: 'root' })\nexport class AuthService {\n  private readonly _user = signal<User | null>(null);\n  private readonly _profile = signal<Profile | null>(null);\n  private readonly _roles = signal<UserRole[]>([]);\n  private readonly _permissions = signal<string[]>([]);\n  private readonly _activeRole = signal<UserRole | null>(null);\n  private readonly _loading = signal(true);\n  private readonly _showRolePicker = signal(false);\n\n  readonly user = this._user.asReadonly();\n  readonly profile = this._profile.asReadonly();\n  readonly roles = this._roles.asReadonly();\n  readonly permissions = this._permissions.asReadonly();\n  readonly activeRole = this._activeRole.asReadonly();\n  readonly loading = this._loading.asReadonly();\n  readonly isAuthenticated = computed(() => !!this._user());\n  readonly showRolePicker = this._showRolePicker.asReadonly();\n\n  private readonly supabase: SupabaseService['client'];\n\n  constructor(\n    private readonly supabaseService: SupabaseService,\n    private readonly router: Router,\n  ) {\n    this.supabase = this.supabaseService.client;\n    this.init();\n  }\n\n  private async init() {\n    const {\n      data: { session },\n    } = await this.supabase.auth.getSession();\n\n    if (session?.user) {\n      this._user.set(session.user);\n      await this.loadProfile(session.user.id);\n    }\n    this._loading.set(false);\n\n    this.supabase.auth.onAuthStateChange((_event, session) => {\n      this._user.set(session?.user ?? null);\n      if (session?.user) {\n        // 不 await，避免阻塞 Supabase 內部的 auth 通知鏈（例如 updateUser 會等通知完成）\n        void this.loadProfile(session.user.id);\n      } else {\n        this._profile.set(null);\n        this._roles.set([]);\n        this._permissions.set([]);\n        this._activeRole.set(null);\n        localStorage.removeItem('clessia:active-role');\n      }\n    });\n  }\n\n  private async loadProfile(userId: string) {\n    const [profileResult, rolesResult] = await Promise.all([\n      this.supabase.from('profiles').select('id, display_name, branch_id').eq('id', userId).single(),\n      this.supabase.from('user_roles').select('role, permissions').eq('user_id', userId),\n    ]);\n\n    this._profile.set(profileResult.data as Profile | null);\n    \n    // Aggregate roles and permissions\n    const roles: UserRole[] = [];\n    const allPermissions = new Set<string>();\n\n    (rolesResult.data ?? []).forEach((r) => {\n      roles.push(r.role as UserRole);\n      if (r.permissions && Array.isArray(r.permissions)) {\n        r.permissions.forEach((p: string) => allPermissions.add(p));\n      }\n    });\n\n    this._roles.set(roles);\n    this._permissions.set(Array.from(allPermissions));\n\n    // Auto-select if user has exactly one role, or restore from storage\n    if (roles.length === 1) {\n      this._activeRole.set(roles[0]);\n    } else {\n      const savedRole = localStorage.getItem('clessia:active-role') as UserRole | null;\n      if (savedRole && roles.includes(savedRole)) {\n        this._activeRole.set(savedRole);\n      }\n    }\n  }\n\n  setActiveRole(role: UserRole) {\n    this._activeRole.set(role);\n    localStorage.setItem('clessia:active-role', role);\n  }\n\n  hasPermission(permission: string): boolean {\n    // Super admins might have a wildcard '*' permission or we check for specific permissions\n    // Here we check if the requested permission exists in the user's permission set\n    return this.permissions().includes(permission) || this.permissions().includes('*');\n  }\n\n  openRolePicker() {\n    this._showRolePicker.set(true);\n  }\n\n  closeRolePicker() {\n    this._showRolePicker.set(false);\n  }\n\n  async signIn(email: string, password: string, captchaToken?: string): Promise<string | null> {\n    const { data, error } = await this.supabase.auth.signInWithPassword({\n      email,\n      password,\n      options: { captchaToken },\n    });\n    if (error) return '帳號或密碼錯誤'; // Standardized error message\n    if (data.user) {\n      this._user.set(data.user);\n      await this.loadProfile(data.user.id);\n    }\n    return null;\n  }\n\n  private readonly shellMap: Record<UserRole, string> = {\n    admin: '/admin',\n    teacher: '/teacher',\n    parent: '/parent',\n  };\n\n  navigateToRoleShell(role: UserRole) {\n    this.setActiveRole(role);\n    this.closeRolePicker();\n    this.router.navigate([this.shellMap[role]]);\n  }\n\n  setRememberMe(value: boolean): void {\n    localStorage.setItem('clessia:remember-me', String(value));\n  }\n\n  async sendPasswordReset(email: string, captchaToken?: string): Promise<string | null> {\n    const { error } = await this.supabase.auth.resetPasswordForEmail(email, {\n      redirectTo: `${window.location.origin}/reset-password`,\n      captchaToken,\n    });\n    return error?.message ?? null;\n  }\n\n  async updatePassword(newPassword: string): Promise<string | null> {\n    const { error } = await this.supabase.auth.updateUser({ password: newPassword });\n    return error?.message ?? null;\n  }\n\n  async signOut() {\n    this.closeRolePicker();\n    await this.supabase.auth.signOut();\n    this._user.set(null);\n    this._profile.set(null);\n    this._roles.set([]);\n    this._permissions.set([]);\n    this._activeRole.set(null);\n    this.router.navigate(['/login']);\n  }\n}\n"],
  "mappings": "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",
  "names": ["session"]
}
