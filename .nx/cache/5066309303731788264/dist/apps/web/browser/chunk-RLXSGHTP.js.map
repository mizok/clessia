{
  "version": 3,
  "sources": ["apps/web/src/app/features/public/pages/reset-password/reset-password.component.ts", "apps/web/src/app/features/public/pages/reset-password/reset-password.component.html"],
  "sourcesContent": ["import { Component, OnDestroy, OnInit, signal } from '@angular/core';\nimport { FormsModule } from '@angular/forms';\nimport { Router, RouterLink } from '@angular/router';\nimport type { Subscription } from '@supabase/supabase-js';\nimport { SupabaseService } from '@core/supabase.service';\n\n@Component({\n  selector: 'app-reset-password',\n  imports: [FormsModule, RouterLink],\n  templateUrl: './reset-password.component.html',\n  styleUrl: './reset-password.component.scss',\n  host: { class: 'u-centered-flex' },\n})\nexport class ResetPasswordComponent implements OnInit, OnDestroy {\n  newPassword = '';\n  confirmPassword = '';\n  submitting = signal(false);\n  done = signal(false);\n  error = signal<string | null>(null);\n  invalidLink = signal(false);\n  sessionReady = signal(false);\n\n  private authSubscription?: Subscription;\n\n  constructor(\n    private readonly supabase: SupabaseService,\n    private readonly router: Router,\n  ) {}\n\n  ngOnInit() {\n    const { data } = this.supabase.client.auth.onAuthStateChange((event, session) => {\n      if (event === 'PASSWORD_RECOVERY' && session) {\n        // email 連結帶 hash 進來 → 合法，清除 hash 防止重整重用\n        this.sessionReady.set(true);\n        this.invalidLink.set(false);\n        // Clean URL (remove hash and query params like 'code')\n        history.replaceState(null, '', window.location.pathname);\n      }\n    });\n    this.authSubscription = data.subscription;\n\n    // 若 3 秒後 PASSWORD_RECOVERY 仍未觸發（lazy load 時序），再做一次判斷\n    setTimeout(async () => {\n      if (this.sessionReady()) return;\n\n      // URL 仍有 hash = 連結剛進來但 listener 晚了；無 hash = 重整\n      // PKCE flow uses query params (code) instead of hash\n      const hasRecoveryHash =\n        window.location.hash.includes('access_token') ||\n        window.location.hash.includes('type=recovery');\n      const hasRecoveryCode = new URLSearchParams(window.location.search).has('code');\n\n      const { data: sessionData } = await this.supabase.client.auth.getSession();\n\n      if (!sessionData.session) {\n        this.invalidLink.set(true);\n      } else if (hasRecoveryHash || hasRecoveryCode) {\n        // 合法連結（lazy load 時序問題）\n        this.sessionReady.set(true);\n        // Clean URL\n        history.replaceState(null, '', window.location.pathname);\n      } else {\n        // 有 session 但沒有 hash → 重整 → 強制清除，要求重新點連結\n        await this.supabase.client.auth.signOut();\n        this.invalidLink.set(true);\n      }\n    }, 3000);\n  }\n\n  ngOnDestroy() {\n    this.authSubscription?.unsubscribe();\n  }\n\n  async onSubmit() {\n    if (this.newPassword !== this.confirmPassword) {\n      this.error.set('兩次輸入的密碼不一致');\n      return;\n    }\n\n    this.error.set(null);\n    this.submitting.set(true);\n\n    try {\n      const timeoutPromise = new Promise<never>((_, reject) =>\n        setTimeout(() => reject(new Error('請求逾時，請重新整理後再試')), 15000),\n      );\n\n      const { error } = await Promise.race([\n        this.supabase.client.auth.updateUser({ password: this.newPassword }),\n        timeoutPromise,\n      ]);\n\n      if (error) {\n        this.error.set(error.message);\n      } else {\n        this.done.set(true);\n        await this.supabase.client.auth.signOut();\n        setTimeout(() => this.router.navigate(['/login']), 2000);\n      }\n    } catch (e) {\n      this.error.set(e instanceof Error ? e.message : '發生未知錯誤，請重試');\n    } finally {\n      this.submitting.set(false);\n    }\n  }\n}\n", "<div class=\"reset-password auth-content\">\n  <header class=\"auth-content__header\">\n    <p class=\"auth-content__badge\">管理系統</p>\n    <h1 class=\"auth-content__title\">重設密碼</h1>\n    <p class=\"auth-content__subtitle\">請輸入您的新密碼</p>\n  </header>\n\n  @if (done()) {\n    <div class=\"message message--success\">\n      <i class=\"pi pi-check-circle\"></i>\n      密碼已重設，即將返回登入頁...\n    </div>\n  } @else if (invalidLink()) {\n    <div class=\"message message--error\">\n      <i class=\"pi pi-exclamation-circle\"></i>\n      連結已失效或過期，請重新申請\n    </div>\n<div class=\"form\">\n      <a class=\"form__link form__link--back form__link--spaced\" routerLink=\"/forgot-password\">\n        <i class=\"pi pi-arrow-left\"></i>\n        重新申請\n      </a>\n    </div>\n  } @else if (!sessionReady()) {\n    <div class=\"message message--info\">\n      <i class=\"pi pi-spinner pi-spin\"></i>\n      驗證連結中...\n    </div>\n  } @else {\n    <form class=\"form\" (ngSubmit)=\"onSubmit()\">\n      @if (error()) {\n        <div class=\"message message--error\">\n          <i class=\"pi pi-exclamation-circle\"></i>\n          {{ error() }}\n        </div>\n      }\n\n      <div class=\"form__field\">\n        <label class=\"form__label\" for=\"newPassword\">新密碼</label>\n        <input\n          id=\"newPassword\"\n          type=\"password\"\n          class=\"form__input\"\n          placeholder=\"輸入新密碼\"\n          [(ngModel)]=\"newPassword\"\n          name=\"newPassword\"\n          required\n          autocomplete=\"new-password\"\n        />\n      </div>\n\n      <div class=\"form__field\">\n        <label class=\"form__label\" for=\"confirmPassword\">確認密碼</label>\n        <input\n          id=\"confirmPassword\"\n          type=\"password\"\n          class=\"form__input\"\n          placeholder=\"再次輸入新密碼\"\n          [(ngModel)]=\"confirmPassword\"\n          name=\"confirmPassword\"\n          required\n          autocomplete=\"new-password\"\n        />\n      </div>\n\n      <button\n        type=\"submit\"\n        class=\"form__submit\"\n        [disabled]=\"submitting() || !newPassword || !confirmPassword\"\n      >\n        @if (submitting()) {\n          <i class=\"pi pi-spinner pi-spin\"></i>\n          更新中...\n        } @else {\n          <i class=\"pi pi-lock\"></i>\n          確認重設\n        }\n      </button>\n    </form>\n  }\n</div>\n"],
  "mappings": "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",
  "names": []
}
