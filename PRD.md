# Clessia 產品需求規格書（PRD）v2.0

系統中文名稱：學程管家
系統英文名稱：Clessia
版本：2.0
最後更新：2026-01-29

---

## 0. 文件定位

這份文件定義 Clessia 的「做什麼」和「為什麼」。

- 描述系統的世界觀、角色、功能、業務規則。
- 所有後續的技術文件都必須符合這份 PRD。

---

## 1. 專案背景

補習班的日常營運有這些常見問題：

1. **出勤紀錄混亂**：學生有沒有到、有沒有上完課，常靠人記或紙本記，容易出錯。
2. **例外處理麻煩**：忘記打卡、臨時請假、事後補請，管理員處理起來很累。
3. **教學紀錄分散**：聯絡簿、作業、成績散落各處，要找很麻煩。
4. **課表管理困難**：課程時間常變動，但又要能追溯歷史。

Clessia 要解決這些問題，讓補習班用最少的力氣，建立完整可追溯的營運紀錄。

---

## 2. 系統目標

1. 以「開課班」和「課堂」為核心，管理出勤和教學紀錄。
2. 讓出勤、請假、聯絡簿都能追溯到具體的某一堂課。
3. 讓成績能追溯到具體的考試事件。
4. 降低管理員處理例外的負擔。
5. 讓任課老師能快速完成每日紀錄。
6. 讓家長能清楚看到孩子的上課狀況、成績、餐費。
7. 所有重要操作都要留紀錄（誰、什麼時候、做了什麼）。

---

## 3. 系統範圍

### 3.1 要做的事

- 課程與開課班管理
- 學生報名（加入開課班）
- 學生到班掃碼
- 出勤管理（出勤歷史紀錄、請假管理）
- 任課老師聯絡簿
- 考試與成績管理
- 餐費報帳
- 調課／代課／停課管理
- 通知中心（課務異動通知）
- 報表匯出

### 3.2 不做的事

- **線上金流**（信用卡、ATM、超商等線上付款串接）
- 招生與行銷
- 排名、競賽功能
- 複雜的多層審批流程

### 3.3 要做但簡化的事

- **線下繳費管理**：記錄現金或銀行轉帳繳費，管理者手動確認收款，不串接金流服務商

---

## 4. 核心概念與名詞定義

這一節定義系統中的核心概念，讀懂這些才能理解後面的內容。

### 4.1 分校（Campus）

補習班的實體據點。一個補習班可能有多個分校（例如：台北校、新竹校）。

- 課堂發生在某個分校的特定教室。
- 老師可能在不同分校之間移動。

### 4.1.1 教室 (Classroom)

分校內的實體教學空間。

- 每個分校有多間教室。
- 每個上課時間 (Schedule) 需指定教室，避免場地衝突。

### 4.2 課程（Course）

教學內容的分類，例如「國一數學」「小五英文」。

- 課程描述的是「教什麼」，不是「什麼時候上」。
- 課程由管理者建立。

### 4.3 開課班（Class）

**這是最重要的概念之一。**

開課班 = 一群學生 + 上同一門課 + 有固定的上課時間。

舉例：

- 「國一數學 A 班」：10 個學生，每週三晚上 + 每週六下午上課。
- 「國一數學 B 班」：8 個學生，每週六早上上課。

這兩個是同一門課程（國一數學）的不同開課班。

開課班的特性：

- 屬於某一門課程。
- 有一群報名的學生。
- 有一個或多個上課時間（上課時間可以指定不同老師）。
- **推薦加選**：可標記為推薦加選，會優先顯示在家長首頁的「推薦加選課程」區塊。
- **適用年級**：設定適合的年級範圍，用於篩選推薦給家長的課程。
- **名額上限**：設定該班級的最大收生人數，用於控管報名與顯示剩餘名額。

### 4.4 上課時間（Schedule）

開課班的上課時間規則，例如「每週三 19:00-21:00」。

- 一個開課班可以有多個上課時間。
- 每個上課時間可以指定不同的老師（保留彈性）。

### 4.5 課堂（Session）

某一天實際發生的一堂課。這是系統中**最核心的資料單位**。

- 課堂由上課時間自動產生（例如：3/5 週三那堂、3/8 週六那堂）。
- 出勤、請假、聯絡簿都依附在課堂上。
- 課堂一旦建立就不能刪除，只能標記停課。

### 4.6 學生報名（Enrollment）

學生加入某個開課班的紀錄。

- 記錄學生、開課班、生效起迄日期。
- 支援月中加入或退出。
- 只有在生效期間內，學生才會出現在該班的課堂名單中。
- **繳費週期**：`monthly`（月繳）或 `semester`（期繳）。
- 同一個學生的不同課程可以有不同繳費週期。
- 同一個開課班可混合不同繳費週期的學生。
- **狀態變更原因**：當報名狀態變更為非活躍狀態（如 `suspended` 停權、`withdrawal` 退選、`void` 失效）時，系統必須記錄變更原因（Reason），以便後續追蹤與分析。

### 4.7 日到班（Check-in）

學生某天到達補習班的事件。

- 同一分校一天最多一次（若學生當天有去不同分校，可各打卡一次）。
- 到班不等於出席，到班會**觸發**系統自動推算當天各課堂的出席狀態。

### 4.8 課堂出席（Attendance）

學生在某一堂課的最終出席狀態。

狀態只有四種：

- **出席（present）**：有來上課。
- **遲到（late）**：有來但晚到。
- **請假（leave）**：事先或事後請假。
- **缺席（absent）**：沒來也沒請假。

### 4.9 請假（Leave）

針對某堂課的請假紀錄。

- 由管理員建立。
- 請假會讓該課堂的出席狀態變成「請假」。

### 4.10 聯絡簿（Teacher Log）

任課老師針對某堂課寫的教學紀錄。

- 包含三個欄位：課程範圍、作業、備註。
- 可附加檔案（最多 3 個，每個 5MB 以內，限圖片/影片/文字檔）。
- 家長可以看到內容並下載附件。

### 4.11 考試事件（Assessment Event）

一次考試。

- **課程歸屬**：考試屬於某門課程（例如「國文模擬考」屬於國文），用於分類。
- **類型區分**：
  1. **隨堂考（In-Class Quiz）**：關聯到特定課堂（Session）。參加範圍**僅限**該課堂所屬的開課班學生。
  2. **聯合模擬考（Joint Exam）**：不關聯特定課堂，而是獨立事件。可指定**多個開課班**共同參加（例如全校國一模擬考）。
- **滿分與及格線**：每次考試可設定滿分（預設 100）和及格分數（預設 60），用於成績顯示判斷。
- 成績記錄在考試事件下。

### 4.12 成績（Grade）

學生在某次考試的分數。

成績狀態：

- **正常（normal）**：有考，有分數。
- **缺考（absent）**：沒考，不計入平均。
- **補考（makeup）**：補考後的分數。

### 4.13 餐費報帳（Meal Record）

學生某天的餐費紀錄。

- 同一天可以有多筆。
- 純粹是紀錄，不涉及實際收款。

### 4.14 課務異動（Schedule Change）

調課、代課、停課的紀錄。

- **調課**：把課堂移到其他時間。
- **代課**：換另一個老師來上。
- **停課**：取消這堂課。

### 4.15 通知（Notification）

系統發送給家長或老師的訊息。

- 主要通知課務異動。
- 站內通知，保留 90 天。
- 系統稽核紀錄（Audit Logs）保留 2 年，用於查詢歷史操作。

### 4.16 出勤模式（Attendance Mode）

分校可設定的出勤計算方式，影響系統如何處理學生出勤。

**日到班模式（預設）**：

- 學生打卡到班後，系統自動推算當天所有課堂的出席狀態：
  - 若打卡時間在課堂開始前（含寬限期）：標記為**出席**。
  - 若打卡時間已超過寬限期：標記為**遲到**。
- 適合學生整天都在補習班的情境。

**課堂模式**：

- 每堂課獨立計算出勤，需管理員或任課老師確認。
- 適合學生可能只來上某幾堂課的情境。

設定層級：分校層級（每個分校可以不同）。
設定權限：僅管理員可設定。

### 4.17 報名申請（Enrollment Request）

報名申請用於追蹤學生報名課程的流程。完成繳費後，系統建立正式報名（Enrollment）。

**申請來源**：

| 來源            | 說明                     | 申請者           |
| --------------- | ------------------------ | ---------------- |
| `public_form`   | 公開報名表單（`/apply`） | 新家長（無帳號） |
| `parent_portal` | 家長後台報名申請頁面     | 已有帳號的家長   |
| `add_course`    | 家長後台加選課程頁面     | 已有帳號的家長   |
| `renewal`       | 續課確認時加選           | 已有帳號的家長   |

- 不同來源的申請共用相同的審核和繳費流程
- `public_form` 來源：繳費完成後系統建立家長帳號和學生資料
- 其他來源：家長和學生資料已存在，繳費完成後直接建立報名

**備註**：試聽流程為獨立流程，請見 4.24 試聽申請。

**申請狀態**：

- **待審核（pending）**：已提交，等待管理員審核。
- **待付款（awaiting_payment）**：審核通過，已建立繳費單，等待繳費。
- **已完成（completed）**：繳費完成，帳號和資料已建立，報名正式生效。
- **已拒絕（rejected）**：管理員拒絕申請（需填寫原因）。
- **已取消（canceled）**：家長取消未審核申請或管理員代為取消（僅限 `pending`）。
- **已過期（expired）**：超過繳費期限仍未付款，系統自動標記。

**申請內容**（公開表單填寫）：

- **家長資訊**：
  - 姓名（必填）
  - Email（選填，優先作為登入帳號）
  - 手機號碼（選填，用於聯繫，無 Email 時作為登入帳號）
  - Email 和手機至少填一個
  - 與學生關係（父/母/其他）
- **學生資訊**：
  - 姓名（必填）
  - 年級（必填）
  - 就讀學校（必填）
- **報名資訊**：
  - 想報名的開課班（必填，可多選）
  - 期望開始日期（選填）
  - 備註（選填，例如特殊需求）

**費用計算規則**：

- 系統依開課班設定的學費自動計算應繳金額。
- 學期中加入可按比例計算（依剩餘課堂數）。
- 管理員建立繳費單時可調整金額（如早鳥優惠、兄弟姊妹折扣）。

**繳費期限**：

- 建立繳費單時設定繳費期限（預設 7 天）。
- 超過期限未繳費，申請狀態自動變為「已過期」。
- 已過期的申請可由管理員重新啟用（延長期限）。

### 4.18 繳費單（Invoice）

記錄應繳費用的單據，關聯到報名申請。

**繳費單內容**：

- 繳費單編號（系統自動產生，格式：INV-YYYYMMDD-XXX）
- 關聯的報名申請
- 學生姓名
- 開課班名稱
- 費用明細（可多項）
- 原價金額
- 折扣/調整金額
- 應繳金額
- 繳費期限
- 繳費狀態
- **訪問權杖 (access_token)**：UUIDv4，用於免登入檢視繳費單。
  > **安全註記**：為保障隱私，點擊連結後需進行**輕量驗證 (Lightweight Verification)**，例如輸入學生「出生年份」或「手機末三碼」才可檢視完整內容。

**繳費狀態**：

- **待付款（pending）**：等待家長繳費。
- **部分付款（partial_paid）**：已繳納部分金額，剩餘款項待繳（Enrollment 可先行手動啟用）。
- **已付款（paid）**：繳費完成。
- **逾期（overdue）**：超過繳費期限但仍在寬限期內。
- **失效（void）**：超過寬限期仍未繳費（報名自動無效，從點名單移除）。
- **已取消（canceled）**：手動取消（報名申請被取消或拒絕）。
- **已退款（refunded）**：全額退款（報名失效）。
  > **MVP 註記**：MVP 階段僅作為帳務註記，系統不會實際退款，需人工線下處理。


### 4.19 繳費紀錄（Payment Record）

實際收款的紀錄。

**MVP 僅支援線下付款**：

- **現金**：家長到補習班現場繳交現金。
- **銀行轉帳**：家長轉帳至補習班指定帳戶。

**繳費紀錄內容**：

- 關聯的繳費單
- 付款金額
- 付款方式（現金/銀行轉帳）
- 付款日期
- 確認人（哪位管理員確認收款）
- 備註（如轉帳帳號末五碼）

**確認流程**：

- 家長完成線下付款後，通知補習班。
- 管理員在系統中確認收款。
- 系統自動執行以下動作：
  1. 更新繳費單狀態為「已付款」
  2. 更新報名申請狀態為「已完成」
  3. **更新正式報名紀錄（Enrollment）**：將狀態由 `pending_payment` 轉為 `active`
  4. **建立家長帳號**（若為新生）
     - **若有 Email**：系統自動發送帳號密碼至 Email（需串接第三方服務）。
     - **若無 Email**：系統產生「帳號資訊卡」，由管理員列印或拍照提供給家長。
  5. **建立學生資料**（若為新生，依申請表的學生資訊）
  6. **關聯家長與學生**（若為新生）
- 家長取得帳號後可登入系統查看孩子的課表和資訊。

**生效規則**：
1. **報名申請審核通過時**：系統立即針對該申請包含的課程項目建立 `pending_payment` 狀態的正式 Enrollment。
   - 學生會出現在該期間的課堂點名單上（標記為「待繳費」）。
   - 若超過繳費期限（或寬限期）未付款，系統自動將 Enrollment 標記為 `void` 並從點名單移除。
2. **全額付清時**：系統自動將對應的所有課程 Enrollment 狀態轉為 `active`。
3. **部分付款時（部分沖銷與強制啟用）**：
   - **彈性啟用**：若收款金額小於應繳總額，管理員在確認收款時可指定「本次欲啟用的課程項目」。
   - **強制啟用 (Force Activation)**：即使該課程項目的金額尚未完全付清（例如分期付款或賒帳），管理員仍可強制啟用該課程的 Enrollment。
   - **狀態處理**：
     - 若未付清但強制啟用：Enrollment 狀態轉為 `active`，繳費單狀態維持 `pending` (或 `overdue`) 直到餘額結清。
     - 若未付清且不啟用：Enrollment 維持 `pending_payment`直到下次付款補足。
   - **雜費處理**：雜費項目（如報名費、教材費）通常不產生 Enrollment，僅記錄付款狀態。
4. **失效恢復 (Reactivation)**：
   - 若繳費單因逾期變為 `void`，但家長隨後補繳（線下付款），管理員確認收款後。
   - 系統應自動恢復權限：將 Enrollment 狀態由 `void` 改回 `active`（或 `pending_payment`），確保學生可繼續上課。
5. **退款時**：若發生全額退款，系統應自動將對應的 Enrollment 標記為失效（設定 `effective_end = NOW()`）。


### 4.20 費用方案（Fee Template）

定義開課班的收費標準，方便快速建立繳費單。

**費用方案內容**：

- 方案名稱（如「國一數學 A 班 - 2026 春季」）
- 關聯的開課班
- 金額
- 生效期間
- 是否支援按比例計算（學期中加入）
- 說明（如「含教材費」）

### 4.21 系統設定（System Settings）

全域系統設定，僅管理員可調整。

**報名流程設定**：

| 設定項目         | 說明                       | 預設值 |
| ---------------- | -------------------------- | ------ |
| 報名審核處理時效 | 新申請應在幾天內完成審核   | 3 天   |
| 試聽跟進啟動天數 | 試聽結束後幾天產生跟進任務 | 1 天   |

**繳費設定**：

| 設定項目       | 說明                   | 預設值 |
| -------------- | ---------------------- | ------ |
| 預設繳費期限   | 建立繳費單時的預設天數 | 7 天   |
| 繳費到期前提醒 | 期限前幾天提醒家長     | 3 天   |

**續課設定**：

| 設定項目       | 說明                     | 預設值     |
| -------------- | ------------------------ | ---------- |
| 月繳發送日期   | 每月幾號產生下期繳費單   | 20 號      |
| 期繳發送日期   | 固定日期清單（逗號分隔） | 1/15, 7/15 |
| 續課寬限期     | 繳費截止後幾天內仍保留名額 | 7 天       |

**學期/週期定義**：

管理員可自訂任意數量的繳費週期，系統不預設固定的「上學期/下學期」結構。

| 設定項目       | 說明                                           |
| -------------- | ---------------------------------------------- |
| 週期名稱       | 自訂名稱（如「春季班」「暑期班」「114上學期」）|
| 起訖日期       | 該週期的開始與結束日期                         |
| 續課通知日     | 在該日期發送續課確認（針對期繳學生）         |
| 是否啟用       | 可暫停不使用的週期                             |

**學年升級設定**：

| 設定項目     | 說明                           | 預設值 |
| ------------ | ------------------------------ | ------ |
| 自動升級日   | 每年自動執行學年升級的日期     | 9/1    |
| 升級前提醒   | 升級前幾天通知管理員確認       | 7 天   |

**快速建立模板**：

首次設定時可從以下模板快速建立，之後可自行調整：

| 模板名稱       | 週期設定                                                       |
| -------------- | -------------------------------------------------------------- |
| 傳統二學期制   | 上學期（9/1-1/31, 通知7/15）、下學期（2/1-6/30, 通知1/15）     |
| 三學期制       | 春季（2/1-5/31）、夏季（6/1-8/31）、秋冬（9/1-1/31）           |
| 學期+暑期班    | 上學期、下學期、暑期班（7/1-8/31, 通知6/15）                   |
| 學期+寒暑假    | 上學期、下學期、寒假班（1/20-2/10）、暑期班（7/1-8/31）        |

> 模板僅為快速起步，管理員可隨時新增、修改、刪除任何週期。月繳學生不受週期設定影響，固定依系統設定的月繳發送日期處理。



**分校資訊**（顯示在報名表單和繳費通知中）：

- 分校名稱
- 聯絡電話
- 銀行帳戶資訊（戶名、銀行、帳號，依分校獨立設定）

### 4.22 待處理工作（Task）

管理員的工作任務管理系統，用於追蹤需要處理的事項。

**任務來源**：

- **系統自動產生**：報名審核、繳費確認、試聽跟進等
- **未來擴充**：上司指派自訂任務（MVP 不做）

**任務資料結構**：

| 欄位     | 說明                                                                                                                                                     |
| -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 任務類型 | trial_arrangement（試聽安排）、enrollment_review（報名審核）、payment_confirmation（繳費確認）、trial_followup（試聽跟進）、renewal_change_request（續課異動處理）、grade_mismatch_exception（年級不符檢查）、grade_mismatch_renewal（續課年級不符） |
| 關聯對象 | 報名申請 ID 或繳費單 ID                                                                                                                                  |
| 指派對象 | 團隊（同分校的管理員）                                                                                                                                   |
| 認領者   | 認領此任務的人（可為空）                                                                                                                                 |
| 狀態     | pending（待認領）、in_progress（處理中）、completed（已完成）、canceled（已取消）                                                                       |
| 截止日期 | 依任務類型自動計算                                                                                                                                       |
| 優先級   | low / medium / high（動態計算）                                                                                                                          |
| 建立時間 | 系統自動記錄                                                                                                                                             |
| 完成時間 | 完成時記錄                                                                                                                                               |

**任務類型與截止日期邏輯**：

| 任務類型 | 觸發時機             | 截止日期計算                              |
| -------- | -------------------- | ----------------------------------------- |
| 試聽安排 | 新試聽申請提交時     | 申請日 + 3 天                             |
| 報名審核 | 新報名申請提交時     | 申請日 + 報名審核處理時效（系統設定）     |
| 繳費確認 | 家長通知已付款時     | 無固定截止（優先級會提高）                |
| 試聽跟進 | 試聽完成時           | 試聽完成日 + 試聽跟進啟動天數（系統設定） |
| 續課異動處理 | 家長提交續課異動時   | 申請日 + 3 天                             |
| 年級不符檢查 | 產生日 + 7 天                             |

**優先級動態計算邏輯**：

| 條件                           | 優先級 |
| ------------------------------ | ------ |
| 預設                           | medium |
| 距離截止日期 ≤ 1 天            | high   |
| 已超過截止日期                 | high   |
| 繳費確認任務（家長已通知付款） | high   |

**認領與轉派機制**：

- **認領制**：任務指派給團隊後，成員需點擊「認領」才能處理
- **轉派**：管理員可將任務轉派給同團隊的其他管理員
- **完成通知**：下屬完成任務時，系統通知其上司

**團隊定義**：

- 同分校的所有管理員為一個團隊
- 系統任務產生時，自動指派給對應分校的團隊

### 4.23 預告制自動續課與繳費通知（Pre-Notification Auto-Renewal）

本系統採用「預告制自動續課」模式：預設學生將繼續就讀，系統自動產生繳費單，但會提前發送預告通知，給予家長調整或取消的緩衝期。

**觸發時機**：

| 繳費週期 | 產生時機                                |
| -------- | --------------------------------------- |
| 月繳     | 每月固定日期（系統設定，如每月 20 號）  |
| 期繳     | 依據該《繳費週期》設定的「續課通知日」  |

**核心流程**：

1.  **預告通知（T-5）**：
    -   在開單日（T-0）前 5 天，系統發送「續課預告」給家長。
    -   通知內容包含：「下期帳單將於 5 天後自動開立。**若需異動或停課，請點此申請**。」
    -   若家長在此期間提交異動申請（如轉班、停課），系統將**暫停該生的自動開單**，並產生「處理續課異動」任務供管理員處理。

2.  **自動開單（T-0）**：
    -   到了開單日，系統針對**未申請異動**的所有符合資格學生，自動建立下一期的繳費單（Invoices）。
    -   到了開單日，系統針對**未申請異動**的所有符合資格學生，自動建立下一期的繳費單（Invoices）。
    -   **前置檢查**：
        1.  **年級不符檢查 (Grade Mismatch Check)**：執行 4.25 定義的檢查。若不符，不開單並產生任務。
        2.  **名額檢查 (Capacity Check)**：檢查 `next_class_id` 的剩餘名額。若已額滿 (Enrollments >= MaxStudents)，不開單並產生任務通知管理員人工處理。
    -   **升班路徑判斷 (Promotion Path)**：
        -   檢查目前開課班是否設定了 `next_class_id`（下一階班級，如國一升國二）。
        -   **若有設定 `next_class_id`**：系統自動以該目標班級建立新一期的繳費單與報名。
        -   **若無設定 `next_class_id`**：系統預設以「原班級」進行續報（適用於不分年級的才藝班或成人班）。
    -   針對**已申請異動**的學生，跳過自動開單，待管理員確認並處理任務（如轉班）後，**需手動開立**正確的繳費單。

3.  **繳費與失效**：
    -   家長收到繳費單通知後進行繳費。
    -   **自動失效 (Auto-Void)**：若超過繳費期限與寬限期（Grace Period）仍未繳費，系統將自動作廢繳費單並暫停學生權限。管理員無需逐一確認是否不讀，僅需處理之後想復學的個案。

**主要優勢**：
-   **低摩擦**：95% 的家長無需任何操作，自動收到帳單並繳費。
-   **高彈性**：保留緩衝期讓家長提出異動，避免開出錯誤帳單。
-   **自動化**：透過自動失效機制解決「幽靈帳單」問題，大幅降低管理員負擔。

**寬限期顯示 (Grace Period Display)**：
在系統設定的寬限期內（如 7 天），即使未繳費，學生仍會出現在點名單上（標記為「待繳費」）。超過寬限期則從點名單移除。

**繳費單產生規則**：

-   金額依該開課班目前的費用方案計算。
-   若有預先設定的折扣（如兄弟姊妹折抵），系統嘗試自動帶入。

### 4.24 試聽申請（Trial Request）

新家長透過公開表單提交的試聽申請，與報名申請（4.17）為獨立流程。

**申請狀態**：

- **待處理（pending）**：已提交，等待管理員安排試聽。
- **已安排（scheduled）**：已安排試聽時間，等待學生參加。
- **已完成（completed）**：試聽結束，已電話跟進確認意願。
- **已取消（canceled）**：家長致電補習班，由管理員代為取消。

**申請內容**（公開表單填寫）：

- **家長資訊**：
  - 姓名（必填）
  - Email（選填，優先作為登入帳號）
  - 手機號碼（選填，無 Email 時作為登入帳號）
  - Email 和手機至少填一個
- **學生資訊**：
  - 姓名（必填）
  - 年級（必填）
  - 就讀學校（必填）
- **試聽資訊**：
  - 想試聽的課程（必填，可多選，選擇課程而非開課班）
  - 方便的時段（選填，如「週三晚上」）
  - 備註（選填）

**試聽安排欄位**（管理員填寫）：

- 安排的試聽課堂（可多堂）
- 試聽日期
- 聯繫備註

**試聽結果欄位**（試聽後填寫）：

- 家長意願（要報名/不報名/考慮中）
- 不報名原因（若選擇不報名）
- 備註

**後續流程**：

- 試聽結束後，管理員電話跟進了解意願
- 若家長決定報名，請家長自行填寫報名申請表單（`/apply`）
- 試聽申請與報名申請為**完全獨立**的流程。即使試聽申請狀態為「已取消」或「待處理」，家長仍可直接提交報名申請。系統內部的關聯僅供數據分析使用。


### 4.25 學年與升級 (Academic Year & Promotion)

### 4.25.1 年級系統定義 (Grade System Definition)

系統採用標準化的 K-12 年級定義，以確保自動升級邏輯的正確性。

**年級列表（由低至高）**：

| 代碼 | 名稱 | 說明 |
| :--- | :--- | :--- |
| `K` | 幼兒園 (Kindergarten) | 學前階段 |
| `P1` | 小學一年級 | |
| `P2` | 小學二年級 | |
| `P3` | 小學三年級 | |
| `P4` | 小學四年級 | |
| `P5` | 小學五年級 | |
| `P6` | 小學六年級 | |
| `J1` | 國中一年級 | |
| `J2` | 國中二年級 | |
| `J3` | 國中三年級 | |
| `S1` | 高中一年級 | |
| `S2` | 高中二年級 | |
| `S3` | 高中三年級 | 最高年級 |

**升級規則**：
- **一般升級**：目前年級為列表中的非最高年級時，自動升級至下一個年級（例如：P6 -> J1）。
- **畢業處理**：目前年級為最高年級（S3）時，升級後狀態更新為「已畢業 (graduated)」，不再具有年級。

管理學生的年級晉升。

- **MVP 階段**：採人工批次處理或系統排程。
- **執行時機**：每年自動執行學年升級的日期（預設為 9/1，見 4.21 系統設定）。
- **流程**：
  1. **年級更新**：系統自動將在學學生年級 +1（國一 -> 國二）。
  2. **畢業處理**：最高年級學生更新為「已畢業」。
  3. **年級不符檢查 (Grade Mismatch Check)**：
     - **時機 1：自動續課開單時（預判）**：
       - 系統在產生下期繳費單前，會檢查「目標班級的適用年級」與「學生預期年級」是否相符。
       - **預期年級計算**：
         - **判斷基準**：下一次自動升級日（通常為今年或明年的 9/1）。
         - **邏輯**：
           - 若 `續課開課日` >= `下一次升級日`：預期年級 = 目前年級 + 1。
           - 若 `續課開課日` < `下一次升級日`：預期年級 = 目前年級。
         - **範例**：
           - 目前 12 月（學生國一）。下一次升級日為明年 9/1。
           - 續報明年 2 月春季班：2/1 < 9/1，預期年級 = 國一（不變）。
           - 續報明年 9 月秋季班：9/1 >= 9/1，預期年級 = 國二（+1）。
       - 若不符，不開單並產生任務通知管理員。
     - **時機 2：年度升級後（補救）**：若學生升級後，其新年級與目前所在班級的「適用年級」不符。系統自動產生任務。
     - 用途：防止開出錯誤年級的帳單，並作為管理員疏失的安全網。

---

## 5. 使用角色與權限

### 5.1 學生（Student）

- **不是登入角色**，學生沒有帳號。
- 學生是資料實體，用來記錄學生資訊。
- 學生的動作只有「到班掃碼」。

### 5.2 家長（Parent）

- 主要為**查看角色**，但可以提交報名申請。
- 可以看：孩子的到班、課表、聯絡簿、成績、餐費、繳費紀錄。
- 可以做：
  - 提交報名申請（為孩子報名課程）。
  - 取消尚未審核的報名申請。
  - 查看繳費單和付款資訊。
- 一個家長可以關聯多個孩子。
- 家長角色可與其他角色兼任；兼任時需切換身分（見 5.7）。

**家長帳號結構**：

| 欄位    | 說明                                        | 可修改                  |
| ------- | ------------------------------------------- | ----------------------- |
| 內部 ID | 系統自動產生（如 P00001），用於所有資料關聯 | 否                      |
| 姓名    | 家長姓名                                    | 是                      |
| Email   | **登入帳號**，優先使用                      | 是（由管理員更換） |
| 手機    | 聯絡用，若無 Email 則作為登入帳號           | 是                      |

- **登入帳號規則**：有 Email 用 Email，無 Email 用手機號碼。
- **唯一性檢查**：Email 和手機在系統中必須唯一，不允許重複。建立或更換時若已存在，顯示錯誤。
- **更換帳號**：管理員可更換 Email 或手機，更換後需重設密碼。
- 所有資料關聯（學生、繳費紀錄等）都用內部 ID，不受登入帳號變更影響。

### 5.3 任課老師（Teacher）

- 負責教學內容。
- 可以做：
  - 填寫自己課堂的聯絡簿。
  - 建立考試事件、輸入成績（限自己任課的班）。
  - 查看自己任課的課表和學生名單。
  - 修改自己課堂的出勤狀態（**僅限當天**，過期需找管理員）。
- 不能做：
  - 修改非當天的出勤（那是管理員的事）。
  - 建立課程、開課班。

### 5.4 系統管理員 (Admin)

本系統的**「系統管理員 (Admin)」**角色負責所有行政和管理事務，採用單一角色搭配權限標籤（Permissions）來區分職責。

- **角色定位**：補習班的營運核心，負責所有行政與管理事務。
- **權限架構**：
    - 所有行政人員、分校主任、總管理者都屬於 `admin` 角色。
    - 透過 `admin_permissions` 欄位控制具體可執行的功能（例如：`manage_staff`、`manage_finance` 等）。
    - **權限管理規則**：擁有 `manage_staff`（人員管理）權限的高階管理員，可以在系統中勾選、指派其他管理員的權限（前提是對方沒有 `manage_staff` 權限，以避免權限無限擴張或互鎖）。

**常見權限標籤範例**：
- `basic_operations`: 查詢與處理日常行政（報名、出勤、請假）。
- `manage_courses`: 課程與排課管理。
- `manage_students`: 學生與家長資料管理。
- `manage_finance`: 財務與收費管理。
- `manage_staff`: 系統帳號與權限管理（唯一可指派他人權限的標籤）。
- `view_reports`: 查看營收與統計報表。

### 5.6 權限總表

所有管理員皆使用 `Admin` 角色，具體功能能不能用取決於是否有對應的 Permission。下表僅列出功能與角色的基本對應關係：

| 功能                     | 管理員 (Admin) *視權限而定 | 老師 (Teacher) | 家長 (Parent) |
| ------------------------ | :---: | :---: | :---: |
| 建立課程與開課班         | ✓ (manage_courses) |               |      |
| 設定費用方案             | ✓ (manage_finance) |               |      |
| 建立/管理學生資料        | ✓      |               |      |
| 建立/管理人員帳號        | ✓ (manage_staff)   |               |      |
| 處理報名/繳費            | ✓      |               |      |
| 修改出勤（不限時間）     | ✓      |               |      |
| 修改出勤（僅限當天）     | ✓      | ✓（自己的課） |      |
| 建立考試/輸入成績        | ✓      | ✓（自己的課） |      |
| 提交試聽/報名申請        |        |               | ✓    |
| 審核申請                 | ✓      |               |      |
| 查看/認領任務            | ✓      |               |      |
| 轉派任務                 | ✓      |               |      |
| 查看營收報表             | ✓ (view_reports)   |               |      |

### 5.7 角色兼任

- **角色可自由組合**：同一個人可以同時擁有任何角色組合（例如：管理員 + 老師 + 家長）。
- **家長兼任處理**：
  - 若使用者同時擁有「家長」與「非家長（管理員/老師）」角色。
  - 登入時預設進入「工作視圖」（管理員/老師介面）。
  - 介面右上角必須提供**「切換身分」**功能，讓使用者切換至「家長視圖」查看自己孩子的資訊。
  - 家長視圖與工作視圖的功能與權限完全隔離。

---

## 6. 完整操作流程

這一節描述從零開始使用系統的完整流程。**請務必完整實作每一個步驟，不可遺漏。**

### 6.1 初始設定流程（管理員執行）

```
步驟 1：建立分校
  └─ 輸入分校名稱、地址

步驟 2：建立課程
  └─ 輸入課程名稱（例如：國一數學）、科目分類

步驟 3：建立人員帳號
  ├─ 建立管理員帳號
  ├─ 建立任課老師帳號
  ├─ 建立家長帳號

步驟 4：建立開課班
  └─ 選擇課程 → 輸入班名（例如：國一數學 A 班）

步驟 5：設定上課時間
  └─ 選擇開課班 → 新增上課時間
     ├─ 選擇分校
     ├─ 選擇星期幾
     ├─ 設定開始/結束時間
     └─ 指定任課老師

步驟 6：產生課堂
  └─ 選擇學期日期範圍 → 系統自動根據上課時間產生該期間的所有課堂
```

### 6.2 試聽申請流程

試聽申請是**獨立流程**，與報名申請完全分離。家長可先試聽體驗課程，試聽結束後若決定報名，需另外填寫報名申請表單。

#### 流程圖

```text
┌─────────────────────────────────────────────────────────────────┐
│                        試聽申請流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  家長（無帳號）           系統                    管理員           │
│       │                    │                       │            │
│     1.│ 填寫試聽申請表單    │                       │            │
│       │──────────────────→│                       │            │
│       │（家長資訊、學生資訊、│                       │            │
│       │  想試聽的課程）     │                       │            │
│       │                    │                       │            │
│       │                    │ 2. 產生「試聽安排」任務 │            │
│       │                    │─────────────────────→│            │
│       │                    │                       │            │
│       │                    │       3. 聯繫家長      │            │
│       │  ←───────────────────────────────────────── │            │
│       │    電話通知試聽時間                         │            │
│       │                    │                       │            │
│       │     4. 到班試聽     │                       │            │
│       │  ─────────────────→│                       │            │
│       │                    │                       │            │
│       │                    │ 5. 試聽完成            │            │
│       │                    │    產生「試聽跟進」任務│            │
│       │                    │─────────────────────→│            │
│       │                    │                       │            │
│       │  ←───────────────────────────────────────── │            │
│       │    6. 電話跟進確認意願                      │            │
│       │                    │                       │            │
│       │                    │                       │            │
│  ┌────┴────────────────────┴───────────────────────┴──┐         │
│  │  家長決定報名 → 請家長自行填寫報名申請表單（/apply）  │         │
│  │  家長不報名   → 標記完成，記錄原因，流程結束         │         │
│  └─────────────────────────────────────────────────────┘         │
│                                                                 │
│  ℹ️ 試聽與報名流程獨立，但系統可記錄來源關聯                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 步驟詳解

**1. 家長填寫試聽申請表單（`/trial`）**

- 不需登入，任何人都可填寫
- 填寫內容：
  - 家長姓名、手機
  - 學生姓名、年級
  - 想試聽的課程（可多選）
  - 方便的時段
  - 備註

**2. 系統產生「試聽安排」任務**

- 任務類型：`trial_arrangement`
- 通知同分校管理員（無需審核，直接安排）

**3. 管理員聯繫家長**

- 認領任務
- 電話聯繫家長，確認試聽時間
- 在系統中安排試聽課堂，申請狀態改為「已安排」

**4. 學生到班試聽**

- 試聽當天，學生到補習班體驗課程
- 管理員在系統標記「試聽完成」

**5. 系統產生「試聽跟進」任務**

- 試聽結束後，系統自動產生跟進任務
- 任務類型：`trial_followup`

**6. 管理員電話跟進**

- 認領任務
- 電話詢問家長意願
- 在系統記錄結果：
  - **要報名**：告知家長填寫報名申請表單（`/apply`）或由管理員直接建立。當系統檢測到報名建立後，將自動標記試聽完成。
  - **不報名**：記錄原因，標記試聽完成
  - **考慮中**：記錄備註，可稍後再跟進

**說明**：
- 試聽申請與報名申請流程獨立。若家長試聽後決定報名，需填寫報名申請表單（系統可自動帶入試聽資料）。
- **自動關閉邏輯**：當系統建立新的報名申請（Enrollment Request）且該學生/家長資料與「進行中的試聽申請」匹配時，系統應自動將該試聽申請標記為「已完成」（若尚未完成），並自動取消或完成關聯的「試聽跟進」任務，避免管理員重複作業。

---

### 6.3 報名申請流程

新生報名透過公開表單（`/apply`）提交，完成繳費後系統才建立帳號和資料。

**注意**：此流程與試聽申請完全獨立。無論是否曾經試聽，報名都從這裡開始。

#### 流程圖

```text
┌─────────────────────────────────────────────────────────────────┐
│                        報名申請流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  家長（無帳號）           系統                    管理員         │
│       │                    │                       │            │
│     1.│ 填寫報名申請表單    │                       │            │
│       │──────────────────→│                       │            │
│       │（家長資訊、學生資訊、│                       │            │
│       │  想報的班、繳費週期）│                       │            │
│       │                    │                       │            │
│       │                    │ 2. 產生「報名審核」任務 │            │
│       │                    │─────────────────────→│            │
│       │                    │                       │            │
│       │                    │       3. 審核申請      │            │
│       │                    │       ┌───────────────┤            │
│       │                    │       │ A. 通過       │            │
│       │                    │       │ B. 拒絕       │            │
│       │                    │       └───────────────┤            │
│       │                    │                       │            │
│  ┌────┴────────────────────┴───────────────────────┴──┐         │
│  │                    【繳費流程】                     │         │
│  ├─────────────────────────────────────────────────────┤         │
│  │  4. 審核通過，建立繳費單 與「待付款學籍」             │         │
│  │     (學生可立即上課，享有寬限期)                     │         │
│  │  5. 管理員電話/email 通知家長繳費資訊                │         │
│  │  6. 家長完成線下付款（現金或銀行轉帳）               │         │
│  │  7. 管理員確認收款                                  │         │
│  │  8. 系統自動執行：                                  │         │
│  │     ✓ 將學籍狀態轉為「正式」(Active)                │         │
│  │     ✓ 建立家長帳號與關聯                           │         │
│  │     ✓ email 發送帳號資訊                           │         │
│  │  9. 家長收到帳號，可登入查看完整資訊                 │         │
│  └─────────────────────────────────────────────────────┘         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 步驟詳解

**1. 家長填寫報名申請表單（`/apply`）**

- 不需登入，任何人都可填寫
- 填寫內容：
  - 家長姓名、手機、Email（選填）
  - 學生姓名、年級、就讀學校（必填）
  - 想報名的開課班（可多選）
  - 繳費週期偏好（月繳/期繳）
  - 期望開始日期
  - 備註

**2. 系統產生「報名審核」任務**

- 任務類型：`enrollment_review`
- 通知管理員

**3. 管理員審核申請**

- 認領任務
- 查看申請詳情
- 兩種處理方式：
  - **A. 審核通過**：建立繳費單，狀態改為「待付款」
  - **B. 拒絕**：填寫拒絕原因，電話通知家長

**4-9. 繳費流程**

- 審核通過時建立繳費單（可調整金額）
- **系統同步建立「待付款學籍」(`pending_payment`)**：學生即使未繳費，在寬限期內也可出現在點名單。
- 電話或 email 通知家長繳費資訊（email 需第三方服務）
- 家長完成線下付款後通知補習班
- 管理員確認收款，系統產生「繳費確認」任務
- 確認後，**系統自動將學籍轉為「正式」(`active`)**
- email 發送帳號密碼給家長（需第三方服務）

#### 管理員直接報名（快速流程）

適用於現場報名、老學生加報、特殊情況等。

```text
步驟 1：建立家長帳號（如果是新家長）
  └─ 輸入姓名、手機、Email

步驟 2：建立學生資料（如果是新生）
  └─ 輸入姓名、年級、就讀學校

步驟 3：關聯家長與學生

步驟 4：直接報名
  ├─ 選擇開課班
  ├─ 選擇繳費週期（月繳/期繳）
  ├─ 設定生效起迄日期
  ├─ 選擇是否建立繳費單
  │   ├─ 是：建立繳費單，狀態為「待付款」
  │   └─ 否：直接建立報名，不產生繳費單
  └─ 確認

完成後效果：
  - 學生立即加入開課班
  - 會出現在課堂出勤名單中
  - 若有繳費單，家長可在系統中查看
```

**重要**：

- 無論哪種方式，學生沒有報名開課班就不會出現在任何課堂的學生名單中。
- 管理員直接報名可選擇是否產生繳費單，方便處理已現場繳費或特殊免費情況。

### 6.4 日常到班流程

```
學生到班掃碼
  │
  └─ 系統建立「日到班」紀錄
     │
     └─ 系統自動推算出勤：
        找出該學生今天有報名的所有課堂
        ↓
        將這些課堂的出席狀態設為「出席」
        ↓
        標記來源為「系統推算」
```

### 6.5 出勤管理流程（管理員執行）

```
情境 A：補登出勤
  └─ 進入課堂詳情 → 選擇學生 → 修改出席狀態
     └─ 標記來源為「人工修改」（優先於系統推算）

情境 B：補請假
  └─ 進入課堂詳情 → 選擇學生 → 建立請假
     └─ 出席狀態自動變為「請假」
```

### 6.6 聯絡簿填寫流程（老師執行）

為解決班級人數眾多時的重複勞動，系統採用「公版內容 + 個人化調整」的兩層式設計。

1. **進入填寫介面**：進入自己的課堂 → 點擊「編輯聯絡簿」。
2. **填寫公版內容 (Class-wide)**：
  - 填寫：課程進度、作業內容、下次考試範圍。
  - 上傳照片（如板書、聯絡清單）。
  - *以上資訊自動套用到全班所有學生。*
3. **快速勾選個人狀態 (Individual Quick Tags)**：
  - 在學生名單中快速點擊勾選：專注度（優/良/待加強）、作業狀況（完成/遲交/未帶）。
  - 如有特殊狀況（如：打瞌睡、家長需特別叮嚀），再針對該生編輯「自定義評論」。
4. **一鍵發送**：
  - 儲存並發送。
  - 家長端立即在該課堂看到**合併公版與個人狀態**的通訊錄內容。

### 6.7 成績輸入流程

```
步驟 1：建立考試事件
  ├─ 選擇課程
  ├─ 輸入考試名稱
  ├─ 選擇日期
  └─（可選）關聯到某堂課

步驟 2：輸入成績
  └─ 選擇考試事件 → 輸入每個學生的分數
     ├─ 正常：輸入分數
     ├─ 缺考：標記缺考（不計入平均）
     └─ 補考：輸入補考分數
```

### 6.8 調課/代課/停課流程（管理員執行）

```
進入課堂詳情 → 選擇異動類型

調課：
  └─ 選擇新的日期時間 → 系統建立新課堂並關聯原課堂

代課：
  └─ 選擇代課老師 →（可選）輸入原因

停課：
  └─ 輸入原因 → 課堂狀態變為「已停課」

完成後效果：
  - 課務異動紀錄被建立
  - 通知發送給家長和老師
```

### 6.9 餐費報帳流程（管理員執行）

```
進入餐費管理 → 新增餐費紀錄
  ├─ 選擇學生
  ├─ 選擇日期
  ├─ 輸入金額
  └─（可選）輸入備註

完成後效果：
  - 家長可以看到餐費紀錄
```

### 6.10 續課流程（預告制）

系統採用「預告制自動續課」，減少家長操作負擔，並透過自動失效機制管理名額。

```text
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│  家長 (App)  │      │   系 統      │      │  管理員 (Web)  │
└──────┬───────┘      └──────┬───────┘      └──────┬───────┘
       │ [T-5 預告日]        │                     │
       │<── 1. 發送續課預告 ─┤                     │
       │ (含異動申請連結)     │                     │
       │                     │                     │
       │ [T-4 ~ T-1]         │                     │
       │ 2. 家長申請異動? ──>│─ 2a. 產生異動任務 ─>│
       │ (若無則無動作)       │                     │<─────┐
       │                     │                     │ 3. 處理異動
       │                     │                     │ (手動調整/停課)
       │                     │                     │───────┘
       │ [T-0 開單日]        │                     │
       │                     │ 4. 自動產生繳費單    │
       │                     │ (跳過有任務的學生)   │
       │<── 5. 發送繳費通知 ─┤                     │
       │                     │                     │
       │ [T+N 繳費期]        │                     │
       ├── 6. 線下繳費 ─────>│                     │
       │                     │─ 7. 銷帳/入班 ─────>│
       │                     │                     │
       │ [T+X 失效日]        │                     │
       │                     │ 8. 自動失效 (Void)   │
       │                     │ (未繳費者停權)       │
       │                     │                     │
```

**詳細步驟說明**：

**1. 系統發送續課預告 (T-5)**
- 系統檢查所有符合續課資格的學生。
- 發送預告通知，告知即將開單。
- 不需要家長點擊「確認」，僅需在「有異動」時點擊申請。

**2. 家長申請異動 (Optional)**
- 若家長決定不讀、轉班或改繳費方式（如月繳改期繳）。
- 點擊通知中的連結，填寫「異動申請單」。
- 系統收到申請後，標記該生「暫停自動開單」，並產生任務。

**3. 管理員處理異動**
- 管理員收到「處理續課異動」任務。
- 聯繫家長確認需求，手動調整課程或標記不續課。
- 任務完成。

**4. 系統自動開單 (T-0)**
- 針對**沒有**未結案異動任務的學生。
- 系統依據費用方案自動建立 `invoices`。

**5. 發送繳費通知**
- 通知家長繳費單已開立。

**6-7. 繳費與銷帳**
- 家長繳費，管理員確認收款（或線上支付自動確認）。
- 學生正式取得下一期上課資格。

**8. 自動失效 (Auto-Void)**
- 若超過「繳費期限 + 寬限期」仍未繳費。
- 系統自動將繳費單狀態改為 `void`。
- 學生的報名狀態改為 `void`（失效）。
- 停止該生的到班權限。
- 管理員無需逐一追蹤，僅需處理後來想復學的家長（重啟帳單）。

---

## 7. 頁面清單與功能

### 7.1 公開頁面（不需登入）

| 頁面         | 路徑        | 功能                           |
| ------------ | ----------- | ------------------------------ |
| 登入頁       | `/login`    | 輸入帳號密碼登入               |
| 學生到班頁   | `/check-in` | 學生掃碼到班                   |
| 試聽申請表單 | `/trial`    | 新家長申請試聽（詳見下方）     |
| 新生報名表單 | `/apply`    | 新家長填寫報名申請（詳見下方） |

**試聽申請表單頁面**：

不需登入，新家長申請試聽的公開表單。

**表單內容**：

- **家長資訊區塊**：
  - 姓名（必填）
  - Email（選填，優先作為登入帳號）
  - 手機號碼（選填，無 Email 時作為登入帳號）
  - Email 和手機至少填一個

- **學生資訊區塊**：
  - 姓名（必填）
  - 年級（必填，下拉選單）
  - 就讀學校（必填）

- **試聽資訊區塊**：
  - 想試聽的課程（必填，可多選）
    - 以課程分類顯示
    - 每個課程顯示：課程名稱、簡介
  - 方便的時段（選填，如「週三晚上」、「週六下午」）
  - 備註（選填）

- **同意條款**：勾選同意個資使用聲明

**提交後畫面**：

- 顯示「試聽申請已送出」成功訊息
- 說明後續流程：「我們會在 1-2 個工作天內與您聯繫安排試聽」
- 顯示補習班聯絡電話

**新生報名表單頁面**：

不需登入，任何人都可填寫的公開報名表單。

**表單內容**：

- **家長資訊區塊**：
  - 姓名（必填）
  - Email（選填，優先作為登入帳號）
  - 手機號碼（選填，無 Email 時作為登入帳號）
  - Email 和手機至少填一個
  - 與學生關係：父親/母親/其他（必填）

- **學生資訊區塊**：
  - 姓名（必填）
  - 年級（必填，下拉選單）
  - 就讀學校（必填）

- **報名資訊區塊**：
  - 想報名的開課班（必填，可多選）
    - 以課程分類顯示可報名的開課班
    - 每個開課班顯示：班名、上課時間、學費
  - 期望開始日期（選填）
  - 備註（選填，可填寫特殊需求）

**提示文字**：表單頂部顯示「若想先試聽再決定，請填寫[試聽申請表單](/trial)」

- **同意條款**：勾選同意個資使用聲明

**提交後畫面**：

- 顯示「申請已送出」成功訊息
- 說明後續流程：「我們會在 1-2 個工作天內與您聯繫」
- 顯示補習班聯絡電話

**表單驗證**：

- 手機號碼格式驗證
- 必填欄位驗證
- 至少選擇一個開課班

**機器人驗證與反濫用**：

- 適用入口：試聽申請（`/trial`）、公開報名申請（`/apply`）、公開繳費單驗證。
- 低摩擦策略：僅在風險升高（同 IP 高頻/異常行為）時要求人機驗證。
- 前端需提交 `captcha_token`，後端驗證失敗直接拒絕。
- 加入基礎速率限制與 honeypot 欄位。

### 7.2 家長頁面

| 頁面     | 路徑                    | 功能                                     |
| -------- | ----------------------- | ---------------------------------------- |
| 家長首頁 | `/parent/dashboard`     | 今日概覽（詳見下方）                     |
| 到班紀錄 | `/parent/attendance`    | 查看孩子的到班歷史（詳見下方）           |
| 課表查看 | `/parent/schedule`      | 查看孩子的課表和課堂（詳見下方）         |
| 成績查閱 | `/parent/grades`        | 查看孩子的考試成績（詳見下方）           |
| 餐費紀錄 | `/parent/meals`         | 查看孩子的餐費紀錄（詳見下方）           |
| 試聽申請 | `/parent/trial`         | 為孩子申請試聽其他課程（詳見下方）       |
| 報名申請 | `/parent/enrollment`    | 提交報名申請、查看申請狀態（詳見下方）   |
| 加選課程 | `/parent/add-course`    | 瀏覽可加選課程、提交加選申請（詳見下方） |
| 繳費紀錄 | `/parent/payments`      | 查看繳費單和繳費紀錄（詳見下方）         |
| 續課資訊 | `/parent/renewal`       | 查看下期續課預覽與申請異動（詳見下方）   |
| 通知中心 | `/parent/notifications` | 查看課務異動通知（詳見下方）             |

**家長首頁內容**：

1. **今日到班狀態**：孩子今天是否已到班（若今日無課則顯示「今日無課」）。
2. **今日/近期課表**：以卡片 Grid 呈現。今天有課就顯示今日課表，若無則顯示最近 3 天的課表。每張卡片顯示時間、課程名、老師、分校。若有課務異動（調課/代課/停課），卡片上需明顯標示。**若該課堂有關聯考試，卡片上顯示「有小考」標籤。**點擊卡片以 Popup 展開課堂詳情。
3. **推薦加選課程**：顯示適合該學生的推薦課程。
   - 以卡片呈現，顯示 2-3 個推薦課程。
   - 每張卡片顯示：課程名稱、上課時間摘要、費用。
   - 底部「查看更多課程」按鈕，點擊展開完整可加選課程清單。
   - 篩選邏輯：依學生年級篩選適合的課程，排除已報名的。
   - 管理員可在課程設定中標記「推薦加選」，優先顯示。
   - 點擊課程卡片開啟課程詳情 Popup，可直接提交加選申請。
4. **最新聯絡簿**：以輪播卡片呈現各課程的最新聯絡簿，每張卡片顯示課程名稱與摘要，點擊卡片以 Popup 展開完整內容（無獨立路由）。
5. **考試與成績**：以卡片 Grid 呈現，合併顯示近期考試和最近成績。
   - **時間範圍**：未來 7 天內的考試 + 過去 7 天內有成績的考試。
   - **卡片內容**：考試名稱、日期（含星期）、分數（若有）、狀態標籤。
   - **卡片狀態與樣式**：
     - 今天考試：暖銅橘淡底，顯示「今天」標籤。
     - 未來考試（無成績）：淡米白底。
     - 滿分成績：淡金底，顯示鼓勵語（「🎉 太厲害了！」），7 天內加「NEW」標籤。
     - 及格成績：淡綠底，7 天內加「NEW」標籤。
     - 不及格成績：淡紫底，顯示鼓勵語（「💪 繼續加油！」），7 天內加「NEW」標籤。
   - **及格判斷**：依該考試設定的及格分數判斷（每次考試可不同）。
   - 若無近期考試也無最近成績，顯示「目前沒有考試安排」。

**家長課堂詳情 Popup 內容**：

- 基本資訊：課程/開課班名稱、上課日期與時間、分校/地點、任課老師
- 出勤狀態：孩子的出勤狀態（出席/遲到/請假/缺席）、到班時間
- 聯絡簿：當堂聯絡簿內容，分區顯示課程範圍、作業、備註
  - 附件列表：顯示老師上傳的附件，可點擊下載或預覽
  - 歷史聯絡簿：該課程過去的聯絡簿記錄（最近 10 堂，可捲動查看）
- 小考標示：若當天有安排小考，顯示小考名稱與一行描述
- 課務異動：若有調課/代課/停課，顯示異動詳情

**到班紀錄頁面**：

- 以日期列表呈現，預設顯示近 10 天。
- 每天顯示：日期、到班狀態（✓ 已到班 + 時間 / ✗ 未到班）、當天課堂列表與出勤狀態。
- 若當天無課，顯示「今日無課」。
- 點擊課堂可開啟課堂詳情 Popup。
- 頂部有日期篩選（近 10 天、近 30 天、指定月份）。
- 往下捲動載入更多歷史。

**課表查看頁面**：

- 桌面版：週曆視圖，顯示一週的課堂卡片。
- 頂部有週切換（< 本週 >）和月曆按鈕（快速跳轉）。
- 課堂卡片顯示時間、課程名，有課務異動時加標記。
- 點擊課堂卡片開啟課堂詳情 Popup。
- 手機版：單日視圖 + 左右滑動切換日期，或垂直列表顯示本週課堂。

時間範圍：

- 過去：可回溯至學生報名該開課班的生效起始日。
- 未來：可查看已產生的未來課堂（依管理員設定的學期範圍）。
- 只顯示學生報名生效期間內的課堂。

**成績查閱頁面**：

- 按課程分組顯示成績，每個課程一個區塊。
- 每筆成績顯示：日期、考試名稱、分數。
- 特殊狀態用標籤標示（缺考、補考）。
- 新成績加「NEW」標籤（7 天內有效）。
- 頂部有篩選：課程篩選（全部/特定課程）、學期篩選（預設當學期）。
- 點擊考試項目可展開詳情（考試描述，如果有的話）。
- MVP 不做圖表，未來可加成績趨勢圖。

**餐費紀錄頁面**：

- 按月份分組顯示，每月一個區塊。
- 每月區塊顯示：月份標題、當月總金額、該月所有餐費明細。
- 每筆明細顯示：日期、餐別（早/午/晚/點心）、金額、備註（若有）。
- 頂部有月份篩選（近 3 個月、近 6 個月、指定月份範圍），預設顯示近 3 個月。
- 匯出功能：
  - 匯出按鈕位於頁面頂部右側。
  - 支援匯出 CSV 格式。
  - 匯出範圍依目前篩選條件。
  - 匯出欄位：日期、餐別、金額、備註。
- 若無餐費紀錄，顯示空狀態提示。

**試聽申請頁面**：

已有帳號的家長為孩子申請試聽其他課程的頁面。

**與公開試聽表單的差異**：

- 公開表單（`/trial`）：新家長使用，需填寫家長和學生資訊
- 此頁面（`/parent/trial`）：已有帳號家長使用，自動帶入資訊

**頁面結構**：

- **分頁切換**：「新增申請」和「申請紀錄」
- **新增申請分頁**：為孩子申請試聽
- **申請紀錄分頁**：查看所有試聽申請的狀態

**新增申請流程**：

1. 選擇孩子（若有多個，可透過孩子切換器新增）
2. 選擇想試聽的課程（可多選）
   - 以課程分組顯示可試聽的開課班
   - 排除孩子已報名的課程
   - 標記為「推薦加選」的課程優先顯示
3. 填寫方便的時段（可選，如「週三晚上」「週末下午」）
4. 填寫備註（可選）
5. 確認提交

**申請紀錄列表**：

- 按提交時間排序（最新在上）
- 每筆顯示：
  - 孩子姓名
  - 想試聽的課程
  - 申請狀態（以顏色標籤區分）
  - 安排的試聽日期（若已安排）
  - 提交日期
- 狀態標籤顏色：
  - 待處理：灰色
  - 已安排：藍色
  - 已完成：綠色
  - 已取消：淺灰

**申請詳情 Popup**：

點擊申請項目後展開：

- 基本資訊：孩子、想試聽的課程、方便時段、備註
- 安排的試聽資訊（若已安排）：日期、時間、地點
- 狀態時間軸：顯示申請的狀態變化歷程
- 若需取消，請電話聯繫補習班，由管理員代為取消（不提供家長自助取消）

**通知中心頁面**：

- 以時間軸列表呈現，最新在上。
- 每則通知顯示：
  - 通知類型圖示（調課/代課/停課用不同圖示）。
  - 標題（例如：「國一數學 A 班 調課通知」）。
  - 摘要內容（例如：「1/30 的課堂已調整至 2/2」）。
  - 發送時間（相對時間：剛剛、5 分鐘前、1 小時前、昨天、1/28）。
  - 已讀/未讀狀態（未讀有藍點標記）。
- 點擊通知展開完整內容（原地展開，不另開 Popup）：
  - 異動類型與原因。
  - 原課堂資訊（日期、時間、老師）。
  - 新課堂資訊（若為調課/代課）。
  - 相關課堂連結（可點擊跳轉至課表該堂課）。
- 點擊即標記為已讀。
- 頂部有「全部標為已讀」按鈕。
- 通知保留 90 天，過期自動消失。
- 若無通知，顯示空狀態提示（「目前沒有通知」）。

**報名申請頁面**：

已有帳號的家長為孩子加報課程、查看申請狀態的頁面。

**注意**：新家長請使用公開報名表單（`/apply`），此頁面僅供已有帳號的家長使用。

**頁面結構**：

- **分頁切換**：「新增申請」和「申請紀錄」。
- **新增申請分頁**：為已關聯的孩子加報新課程。
- **申請紀錄分頁**：查看所有申請的狀態。

**新增申請流程**：

1. 選擇孩子（若有多個，可透過孩子切換器新增）
2. 選擇開課班
   - 以課程分組顯示可報名的開課班
   - 每個開課班顯示：班名、上課時間、剩餘名額、學費
   - 可搜尋課程或班名
3. 選擇期望開始日期
4. 填寫備註（可選）
5. 確認提交

**申請紀錄列表**：

- 按提交時間排序（最新在上）
- 每筆顯示：
  - 孩子姓名
  - 開課班名稱
  - 申請狀態（以顏色標籤區分）
  - 提交日期
- 狀態標籤顏色：
  - 待審核：灰色
  - 待付款：暖銅橘
  - 已完成：綠色
  - 已拒絕：紅色
  - 已取消：淺灰
  - 已過期：淺灰

**申請詳情 Popup**：

點擊申請項目後展開，顯示完整資訊：

- 基本資訊：孩子、開課班、期望開始日期、備註
- 狀態時間軸：顯示申請的狀態變化歷程
- 若為「待付款」狀態：
  - 顯示繳費單資訊（金額、繳費期限）
  - 顯示付款方式說明（現金/銀行轉帳）
  - 顯示補習班帳戶資訊（若支援轉帳）
- 若為「已拒絕」狀態：顯示拒絕原因
- 操作按鈕：
  - 「待審核」狀態：可取消申請
  - 其他狀態：無操作按鈕

**加選課程頁面**：

已有帳號的家長為孩子瀏覽並加選新課程的頁面。

**與報名申請頁面的差異**：

- **報名申請**：以申請流程為中心，包含「新增申請」和「申請紀錄」分頁
- **加選課程**：以課程瀏覽為中心，提供更好的探索和篩選體驗

**頁面結構**：

- **學生切換**：頂部顯示目前選擇的孩子（使用共用的孩子切換器，可切換或新增孩子）
- **篩選區塊**：篩選可加選的課程
- **課程列表**：符合條件的可加選課程

**篩選功能**：

- **課程類型篩選**：依科目分類篩選（如：數學、英文、國文等）
- **上課時間篩選**：依星期幾篩選（避免時間衝突）
- **關鍵字搜尋**：搜尋課程名稱或班名

**課程列表**：

以卡片 Grid 呈現可加選的課程：

- **篩選邏輯**：
  - 依學生年級篩選適合的課程（使用開課班的「適用年級」設定）
  - 排除學生已報名的開課班
  - 標記為「推薦加選」的課程優先顯示並加上標籤
- **每張課程卡片顯示**：
  - 推薦標籤（若有標記推薦加選）
  - 課程名稱、開課班名稱
  - 上課時間摘要（如「週三 18:00-20:00」）
  - 授課老師
  - 剩餘名額（若名額緊張以紅色標示）
  - 費用（月費或學期費）
- **空狀態**：若無可加選課程，顯示「目前沒有適合的可加選課程」

**課程詳情 Popup**：

點擊課程卡片後展開詳情：

- **課程資訊**：
  - 課程名稱、開課班名稱
  - 課程簡介（若有）
  - 上課時間（完整列出每週時段）
  - 授課老師
  - 上課地點/分校
  - 目前人數 / 名額上限
- **費用資訊**：
  - 月繳費用或學期費用
  - 費用說明（若有）
- **加選按鈕**：「加選此課程」

**加選申請流程**：

點擊「加選此課程」後：

1. **選擇繳費週期**：月繳或期繳（若該課程支援多種）
2. **選擇期望開始日期**
3. **填寫備註**（可選）
4. **確認送出**

**送出後**：

- 產生報名申請（走審核流程）
- 顯示成功訊息：「已提交加選申請，請等待審核」
- 可選擇「繼續瀏覽」或「查看申請狀態」
- 查看申請狀態導向報名申請頁面的「申請紀錄」分頁

**繳費紀錄頁面**：

家長查看所有繳費單和繳費紀錄的頁面。

**頁面結構**：

- **統計區塊**：顯示待繳總額、本學期已繳總額
- **繳費單列表**：所有繳費單

**繳費單列表**：

- 按狀態分組：待付款（優先顯示）、已付款、已取消
- 每筆顯示：
  - 繳費單編號
  - 孩子姓名
  - 開課班名稱
  - 金額
  - 狀態標籤
  - 繳費期限（待付款）/ 付款日期（已付款）

**繳費單詳情 Popup**：

點擊繳費單後展開：

- 繳費單編號
- 學生姓名
- 費用明細（項目、金額）
- 折扣/調整（若有）
- 應繳金額
- 繳費期限
- 狀態
- 若為「待付款」：
  - 付款方式說明
  - 補習班帳戶資訊
  - 提醒文字：「完成付款後請通知補習班確認」
- 若為「已付款」：
  - 付款日期
  - 付款方式
  - 確認人

**家長首頁待繳費提醒**：

若有待付款的繳費單，在家長首頁頂部顯示提醒卡片：

```text
┌────────────────────────────────────────────┐
│ 💰 有待繳費用                               │
├────────────────────────────────────────────┤
│ 國一數學 A 班 - 2026 春季學費               │
│ NT$ 11,500 · 期限：2026/02/15              │
│                                            │
│              [查看詳情]                     │
└────────────────────────────────────────────┘
```

- 即將到期（3 天內）：卡片邊框變紅色
- 已過期：卡片背景變淡紅色

**續課資訊與異動頁面**：

此頁面讓家長預覽即將自動續課的內容，並在開單前提供異動申請的入口。

**頁面結構**：

- **標題區塊**：顯示下期適用期間（如「2026 春季」）。
- **狀態提示**：
  - 正常狀態：「系統將於 [2026/02/20] 自動開立繳費單，無需操作。」
  - 異動處理中：「您已提交異動申請，管理員處理中，自動開單已暫停。」
- **續課預覽區塊**：列出系統預計自動續報的課程。
- **異動申請連結**：提供「申請轉班/停課」按鈕。

**續課預覽區塊**：

- 每筆顯示：
  - 課程名稱
  - **新班級名稱**（若有升班，標註「升級」）
  - 上課時間
  - 預計費用
- 此處僅供檢視，不可直接勾選或取消（需透過異動申請）。

**異動申請功能**：

點擊「申請異動」後開啟 Popup：

1. 選擇要異動的課程。
2. 選擇異動類型：
   - **轉班**：填寫希望轉入的班級或時段。
   - **停課（不續報）**：填寫原因。
   - **變更繳費方式**：如改為期繳。
3. 填寫備註。
4. 確認送出。

送出後：
- 系統產生「續課異動」任務通知管理員。
- 頁面狀態更新為「異動處理中」。
- **該生的自動開單流程暫停**，直到管理員處理完畢。

**加選課程連結**：

- 預覽清單下方顯示提示：「想加選其他課程？」
- 提供「瀏覽可加選課程」按鈕，導向加選課程頁面（`/parent/add-course`）。

**無待確認狀態**：

若目前沒有預定的自動續課（如本期剛開始），顯示：

- 「目前沒有即將到來的續課」
- 下次預計開單日期

**家長首頁續課提醒**：

在 T-5 ~ T-0 期間，家長首頁顯示預告通知：

- 標題：「[期間] 續課預告」
- 內容：「繳費單將於 [日期] 自動開立」
-「申請異動」按鈕

家長頁面共通功能：

- 如果有多個孩子，可以切換查看不同孩子。
- 預設顯示第一個孩子。

### 7.3 老師頁面

| 頁面     | 路徑                     | 功能                                             |
| -------- | ------------------------ | ------------------------------------------------ |
| 我的課表 | `/teacher/calendar`      | 日曆顯示自己任課的課堂（詳見下方）               |
| 考試管理 | `/teacher/assessments`   | 建立考試事件、查看考試列表、輸入成績（詳見下方） |
| 通知中心 | `/teacher/notifications` | 查看課務異動通知（與家長通知中心類似）           |

**我的課表頁面**：

採用列表視圖為主、月曆為輔的設計，解決日曆格子塞不下多堂課的問題。

- **桌面版**：左側小型月曆 + 右側課堂列表。
- **手機版**：頂部月曆選擇器（可收合）+ 課堂列表。

**月曆區塊**：

- 小型月曆，有課的日期顯示圓點標記。
- 點擊日期可快速跳轉至該日課堂。
- 頂部有月份切換（< 2月 >）和「今天」按鈕。

**課堂列表區塊**：

- 按日期分組顯示課堂，預設顯示本週。
- 每個日期標題顯示：日期、星期（例如「2/5（三）」）。
- 每筆課堂顯示：時間、開課班名稱、標記。
- 課堂卡片標記：
  - **待處理標記（●）**：暖銅橘色小圓點，位於卡片右側。
    - 觸發條件：過去課堂尚未填寫聯絡簿，或有關聯考試但成績尚未登錄。
  - **[有小考]**：該課堂有關聯考試。
  - **[代課]**：自己代課（非原任課老師）。
  - **課務異動標記**：依 8.6 規則顯示（調課/停課等）。
- 點擊課堂 → 開啟課堂詳情 Popup。
- 列表可上下捲動查看更多日期。

**圖例說明**（顯示在頁面底部或月曆下方）：

- ● 待處理：聯絡簿未填或成績未登錄
- [有小考] 該課堂有安排考試
- [代課] 代課課堂
- 灰底 = 已停課

**老師課堂詳情 Popup**（從課表點擊課堂卡片開啟）：

- 查看該堂課的學生名單和出勤狀態
- 修改出勤狀態（**僅限當天**的課堂）
- 填寫/編輯聯絡簿（點擊後開啟聯絡簿編輯 Popup）
- 查看/建立小考（關聯此課堂的考試）

**聯絡簿編輯 Popup**：

從課堂詳情 Popup 點擊「編輯聯絡簿」後開啟，用於填寫教學紀錄。

- **Popup 標題**：「編輯聯絡簿」+ 開課班名稱 + 日期時間。
- **UI 佈局**：
  - **左側/上方 (公版內容區)**：
    - 使用 Markdown 編輯器填寫：課程範圍、作業內容、下次小考範圍。
    - 媒體上傳：最多 3 個檔案。
  - **右側/下方 (學生名單區)**：
    - 表格列出所有學生。
    - 每位學生後方有「快速標籤」：專注度（3階）、作業（3階）。
    - 個別備註欄：點擊展開小輸入框，填寫特定個別評語。

- **操作按鈕**：
  - 「儲存草稿」：僅儲存，家長尚不可見。
  - 「發送聯絡簿」：正式發布給所有家長。
- **桌面版**：寬版分欄佈局（左側公版，右側名單）。
- **手機版**：垂直排列，先顯示公版區，下方接學生名單列表。

**聯絡簿填寫狀態**：

- 課堂卡片上的待處理標記（●）會在聯絡簿未填寫時顯示。
- 「未填寫」判定：三個欄位（課程範圍、作業、備註）全部為空。
- 只要任一欄位有內容，即視為已填寫（不強制三欄都填）。

**考試管理頁面**：

採用分頁設計，方便老師快速處理待輸入成績的考試。

**頁面結構**：

- **分頁切換**：「待處理」和「全部」兩個分頁。
- **待處理分頁**（預設）：只顯示尚未完成成績登錄的考試，依日期由近到遠排序。
- **全部分頁**：顯示所有考試，可篩選課程、日期範圍。

**考試列表**：

- 每筆顯示：考試名稱、課程、日期、完成狀態（已完成/進行中）、進度（例如「8/10 已登錄」）。
- 待處理分頁的考試卡片右側顯示暖銅橘小圓點（●），提醒老師處理。
- 點擊考試 → 開啟「成績輸入 Popup」。

**完成狀態邏輯**：

- **自動完成**：當所有參加學生都已輸入分數或標記缺考時，系統自動將考試標記為「已完成」。
- **手動完成**：老師可點擊「標記完成」按鈕，強制將考試標記為已完成（即使仍有學生未輸入）。
- 已完成的考試仍可編輯成績，編輯後狀態維持「已完成」。

**建立考試流程**：

1. 點擊「新增考試」按鈕。
2. 輸入考試名稱。
3. 選擇課程歸屬。
4. 選擇課堂關聯（可選，從自己的課堂中選）。
5. 若無課堂關聯，輸入考試日期。
6. 設定滿分（預設 100）和及格分數（預設 60）。
7. 選擇參加範圍（樹狀結構多選開課班，僅顯示自己任課的班）。
8. 儲存。

**成績輸入 Popup**：

從考試管理頁面點擊考試後開啟，用於輸入學生成績。

- **Popup 標題**：考試名稱 + 日期。
- **學生名單表格**：
  - 欄位：學生姓名、開課班、分數輸入框、狀態下拉（正常/缺考/補考）。
  - 預設顯示參加範圍內的學生。
  - 未輸入分數的學生行底色稍淡，提醒老師處理。
- **操作按鈕**：
  - 「加入其他學生」：搜尋並加入非預設範圍的學生。
  - 「全部標記缺考」：批次將所有未輸入分數的學生標記為缺考。
  - 「下載範本」：下載成績輸入範本（詳見下方匯入功能）。
  - 「匯入成績」：上傳填好的範本檔案。
  - 「儲存」：儲存目前輸入的成績，Popup 保持開啟。
  - 「儲存並關閉」：儲存並關閉 Popup。
  - 「標記完成」：手動將此考試標記為已完成。
- **桌面版**：寬版 Popup（max-width: 720px），表格直接顯示。
- **手機版**：全螢幕 Modal，學生以卡片列表呈現，每張卡片包含姓名、班級、分數輸入。
- MVP 不實作成績鎖定機制，儲存後可隨時再編輯。

**成績匯入功能**：

支援 CSV 和 Excel（.xlsx）格式的批次成績匯入，適合大量成績輸入（如模擬考）。

**匯入流程**：

1. 點擊「下載範本」，系統產生該考試的範本檔案。
2. 範本內容：學生 ID（系統自動填）、學生姓名（系統自動填）、開課班（系統自動填）、分數（待填）、狀態（待填，可選）。
3. 老師在 Excel 或試算表中填寫分數欄位。
4. 點擊「匯入成績」上傳檔案。
5. 系統以學生 ID 進行匹配，顯示預覽結果：
   - 成功匹配的學生及其分數。
   - 無法匹配的資料列（例如 ID 不存在）。
6. 確認後匯入，覆蓋現有成績。

**範本格式**：

```
學生ID, 學生姓名, 開課班, 分數, 狀態
S001, 王小明, 國一數學A班, ,
S002, 李小華, 國一數學A班, ,
S003, 陳大文, 國一數學B班, ,
```

- 分數欄位：填入數字。
- 狀態欄位：可填「正常」「缺考」「補考」，留空預設為「正常」。

**注意事項**：

- 範本僅包含該考試參加範圍內的學生。
- 若需加入範圍外的學生，先用「加入其他學生」功能新增後再下載範本。
- 匯入會覆蓋已輸入的成績，系統會提示確認。

### 7.4 管理員常用頁面

| 頁面                     | 路徑                | 功能                                         |
| ------------------------ | ------------------- | -------------------------------------------- |
| 課程日曆                 | `/staff/calendar`   | 日曆顯示所有課堂，可進入課堂詳情（詳見下方） |
| **出勤管理**（收合選單） |                     |                                              |
| ├ 出勤歷史紀錄           | `/staff/attendance` | 查看/修正學生出勤狀態                        |
| └ 請假管理               | `/staff/leave`      | 建立/查詢請假紀錄                            |
| 餐費管理                 | `/staff/meals`      | 新增/查詢餐費紀錄、匯入匯出                  |
| 成績查閱                 | `/staff/grades`     | 查詢學生成績                                 |
| 課堂搜尋                 | `/staff/sessions`   | 依條件搜尋課堂                               |
| 課務異動紀錄             | `/staff/changes`    | 查看調課/代課/停課紀錄                       |
| 待處理工作               | `/admin/tasks`      | 查看、認領、處理任務（與管理員共用頁面設計） |

**課程日曆頁面**：

採用與老師課表相同的「列表視圖為主、月曆為輔」設計，但顯示全校所有課堂。

- **桌面版**：左側小型月曆 + 右側課堂列表。
- **手機版**：頂部月曆選擇器（可收合）+ 課堂列表。

**篩選列**（位於頁面頂部）：

- 課程篩選：下拉選單，選擇後開課班篩選會連動更新。
- 開課班篩選：下拉選單，依課程篩選結果顯示對應的開課班。
- 老師篩選：下拉選單，可篩選特定老師的課堂。
- 篩選邏輯：三個篩選為 AND 關係，預設全部顯示。

**月曆區塊**：

- 小型月曆，有課的日期顯示圓點標記。
- 點擊日期可快速跳轉至該日課堂。
- 頂部有月份切換（< 2月 >）和「今天」按鈕。

**課堂列表區塊**：

- 按日期分組顯示課堂，預設顯示本週。
- 每筆課堂顯示：時間、開課班名稱、**老師名稱**。
- 課務異動標記：依 8.6 規則顯示（調課/代課/停課）。
- 點擊課堂 → 開啟課堂詳情 Popup。

**管理員課堂詳情 Popup**：

- 查看學生名單和出勤狀態。
- 修改出勤狀態（不限時間）。
- 建立請假。
- 執行調課/代課/停課。
- 查看聯絡簿（唯讀，由老師填寫）。

**出勤歷史紀錄頁面**：

提供查看和修正學生出勤狀態的功能，主要用於補登、修正出勤。

**頁面結構**：

- **篩選列**：日期範圍、課程、開課班、出勤狀態（全部/有異常）。
- **課堂列表**：符合篩選條件的課堂，按日期排序（最近在上）。

**課堂列表**：

- 每筆顯示：日期、時間、開課班名稱、老師、出勤摘要（例如「10 出席 / 1 遲到 / 1 缺席」）。
- 有異常的課堂（有缺席或遲到）加標記提醒。
- 點擊課堂 → 開啟管理員課堂詳情 Popup（同課程日曆）。

**快速操作**：

- 在列表中可快速展開課堂的學生出勤狀態，不必進入 Popup。
- 直接在展開區域修改出勤狀態並儲存。

**請假管理頁面**：

提供建立和查詢請假紀錄的功能。

**頁面結構**：

- **分頁切換**：「待處理」和「全部」。
- **待處理分頁**：顯示今天或未來的請假申請（如果有審核流程，MVP 先不做審核）。
- **全部分頁**：所有請假紀錄，可篩選。

**篩選列**（全部分頁）：

- 日期範圍、學生姓名、課程、開課班。

**請假列表**：

- 每筆顯示：學生姓名、請假日期、課堂（課程+時間）、請假原因、建立時間、建立者。
- 點擊可展開編輯或刪除。

**新增請假 Popup**：

1. 選擇學生（可搜尋）。
2. 選擇請假日期。
3. 系統顯示該學生當天的課堂列表，勾選要請假的課堂（可多選）。
4. 輸入請假原因（可選）。
5. 確認建立。

**批次請假**：

- 選擇一個課堂 → 勾選多個學生 → 批次建立請假（例如全班校外教學）。

**餐費管理頁面**：

提供新增和查詢餐費紀錄的功能。

**頁面結構**：

- **篩選列**：日期範圍、學生姓名。
- **統計區塊**：顯示篩選範圍內的總金額。
- **餐費列表**：符合條件的餐費紀錄。

**餐費列表**：

- 按日期分組，每日顯示小計。
- 每筆顯示：學生姓名、餐別（早/午/晚/點心）、金額、備註。
- 點擊可編輯或刪除。

**新增餐費 Popup**：

1. 選擇日期（預設今天）。
2. 選擇學生（可搜尋，可多選）。
3. 選擇餐別。
4. 輸入金額。
5. 輸入備註（可選）。
6. 確認新增。

**批次新增**：

- 選擇多個學生 + 同一餐別 + 同一金額 → 批次建立（例如全班午餐）。

**匯入匯出**：

- **匯出**：依篩選條件匯出 CSV，欄位包含日期、學生、餐別、金額、備註。
- **匯入**：上傳 CSV 批次匯入餐費紀錄（格式需符合範本）。
- 提供 CSV 範本下載。

**成績查閱頁面**：

供管理員查詢所有學生成績，與家長成績頁面類似但範圍更廣。

**頁面結構**：

- **篩選列**：學生姓名、課程、開課班、日期範圍。
- **成績列表**：符合條件的成績紀錄。

**成績列表**：

- 按考試分組或按學生分組（可切換）。
- 每筆顯示：學生姓名、考試名稱、課程、日期、分數、狀態（正常/缺考/補考）。
- 及格/不及格用顏色區分（依該考試設定的及格線）。

**匯出功能**：

- 依篩選條件匯出 CSV。
- 欄位：學生姓名、開課班、考試名稱、課程、日期、分數、狀態。

**課堂搜尋頁面**：

提供依各種條件搜尋課堂的功能，方便快速找到特定課堂。

**篩選條件**：

- 日期範圍（必填）。
- 課程（可選）。
- 開課班（可選，依課程連動）。
- 老師（可選）。
- 分校（可選）。
- 課堂狀態：全部/正常/已停課/有異動。

**搜尋結果**：

- 課堂列表，按日期排序。
- 每筆顯示：日期、時間、開課班、老師、分校、狀態標記。
- 點擊課堂 → 開啟課堂詳情 Popup。

**快速篩選標籤**：

- 頁面頂部提供快速篩選：「今天」「本週」「有異動」「已停課」。

**課務異動紀錄頁面**：

查看所有調課/代課/停課的歷史紀錄。

**頁面結構**：

- **篩選列**：日期範圍、異動類型（全部/調課/代課/停課）、課程、老師。
- **異動列表**：符合條件的異動紀錄，按建立時間排序（最新在上）。

**異動列表**：

- 每筆顯示：
  - 異動類型圖示（調課/代課/停課用不同圖示）。
  - 課堂資訊：開課班、原日期時間。
  - 異動內容摘要：
    - 調課：「調整至 [新日期時間]」
    - 代課：「由 [代課老師] 代課」
    - 停課：「已停課」
  - 原因（若有）。
  - 建立時間、建立者。
- 點擊可展開完整詳情。

**詳情展開內容**：

- 原課堂完整資訊。
- 異動後資訊（若為調課/代課）。
- 通知發送狀態：已通知的家長/老師數量。
- 操作紀錄：誰在什麼時候建立的。

### 7.5 管理員頁面（Admin Pages）

以下頁面所有管理員都可以使用，路徑前綴為 `/admin`：

| 頁面       | 路徑                         | 功能                                           |
| ---------- | ---------------------------- | ---------------------------------------------- |
| 學生管理   | `/admin/students`            | 建立/編輯學生資料                              |
| 家長管理   | `/admin/parents`             | 建立家長帳號、關聯學生                         |
| 試聽管理   | `/admin/trials`              | 管理試聽申請、安排試聽、跟進（詳見下方）       |
| 報名審核   | `/admin/enrollment-requests` | 審核家長提交的報名申請（詳見下方）             |
| 繳費管理   | `/admin/payments`            | 管理繳費單、確認收款（詳見下方）               |
| 續課管理   | `/admin/renewals`            | 查看續課確認狀態、跟進未確認的家長（詳見下方） |
| 待處理工作 | `/admin/tasks`               | 查看、認領、處理任務（詳見下方）               |

### 7.6 管理員專屬頁面

以下頁面僅管理員可使用，路徑前綴為 `/manager`：

| 頁面         | 路徑                     | 功能                                       |
| ------------ | ------------------------ | ------------------------------------------ |
| 分校管理     | `/manager/campuses`      | 建立/編輯分校、設定出勤模式                |
| 課程管理     | `/manager/courses`       | 建立/編輯課程                              |
| 開課班管理   | `/manager/classes`       | 建立開課班、設定上課時間、產生課堂         |
| 費用方案管理 | `/manager/fee-templates` | 設定開課班的收費標準（詳見下方）           |
| 學生報名     | `/manager/enrollment`    | **直接把學生加入開課班**（跳過申請流程）   |
| 人員管理     | `/manager/staff`         | 建立老師/管理員帳號                          |
| 系統設定     | `/manager/settings`      | 試聽跟進、繳費、補習班資訊設定（詳見下方） |

**分校管理頁面**：

管理補習班的各個分校。

**頁面結構**：

- **分校列表**：顯示所有分校。
- **新增分校按鈕**。

**分校列表**：

- 每筆顯示：分校名稱、地址、聯絡電話、狀態（啟用/停用）。
- 點擊進入編輯。

**新增/編輯分校 Popup**：

| 欄位     | 類型 | 必填 | 說明                 |
| -------- | ---- | ---- | -------------------- |
| 分校名稱 | 文字 | 是   | 例如：台北校、台中校 |
| 地址     | 文字 | 否   |                      |
| 聯絡電話 | 文字 | 否   |                      |
| 狀態     | 開關 | 是   | 啟用/停用            |

**課程管理頁面**：

管理補習班開設的課程（全補習班共用，不分分校）。

**頁面結構**：

- **課程列表**：顯示所有課程。
- **新增課程按鈕**。

**課程列表**：

- 每筆顯示：課程名稱、科目、開課班數量、狀態。
- 點擊進入編輯。

**新增/編輯課程 Popup**：

| 欄位     | 類型     | 必填 | 說明                          |
| -------- | -------- | ---- | ----------------------------- |
| 課程名稱 | 文字     | 是   | 例如：國一數學、國二英文      |
| 科目     | 下拉選單 | 是   | 國文/英文/數學/自然/社會/其他 |
| 說明     | 長文字   | 否   | 課程簡介                      |
| 狀態     | 開關     | 是   | 啟用/停用                     |

**開課班管理頁面**：

管理各分校的開課班，設定上課時間，產生課堂。

**頁面結構**：

- **篩選列**：分校、課程、狀態。
- **開課班列表**：符合條件的開課班。
- **新增開課班按鈕**。

**開課班列表**：

- 每筆顯示：開課班名稱、分校、課程、上課時間摘要、目前人數/上限、狀態。
- 點擊展開詳情或進入編輯。

**開課班詳情展開**：

- 上課時間列表（每個時段的時間、老師）。
- 學生名單摘要（人數、可展開查看）。
- 快速操作：編輯、產生課堂、停用。

**新增/編輯開課班 Popup**：

**基本資訊**：

| 欄位       | 類型     | 必填 | 說明                |
| ---------- | -------- | ---- | ------------------- |
| 開課班名稱 | 文字     | 是   | 例如：國一數學 A 班 |
| 分校       | 下拉選單 | 是   | 選擇所屬分校        |
| 課程       | 下拉選單 | 是   | 選擇關聯課程        |
| 人數上限   | 數字     | 是   | 例如：20            |
| 狀態       | 開關     | 是   | 啟用/停用           |

**上課時間設定**：

一個開課班可以有多個上課時段，每個時段獨立設定：

| 欄位       | 類型     | 必填 | 說明               |
| ---------- | -------- | ---- | ------------------ |
| 星期       | 下拉選單 | 是   | 週一～週日         |
| 開始時間   | 時間選擇 | 是   | 例如：19:00        |
| 結束時間   | 時間選擇 | 是   | 例如：21:00        |
| 任課老師   | 下拉選單 | 是   | 選擇老師           |
| 生效起始日 | 日期選擇 | 是   | 這個時段從何時開始 |
| 生效結束日 | 日期選擇 | 否   | 留空表示持續有效   |

- 「+ 新增時段」按鈕可新增多個上課時段。
- 每個時段可獨立刪除或編輯。

**產生課堂功能**：

根據上課時間設定，批次產生指定日期範圍內的課堂。

1. 點擊「產生課堂」按鈕。
2. 選擇日期範圍（起始日、結束日）。
3. 系統預覽將產生的課堂列表（日期、時間、老師）。
4. 確認後批次建立課堂。

**注意事項**：

- 只會產生上課時間「生效期間」內的課堂。
- 已存在的課堂不會重複建立。
- 產生後可在課程日曆查看和管理。

**學生管理頁面**：

管理學生基本資料。

**頁面結構**：

- **篩選列**：姓名搜尋、年級、分校（依報名的開課班所屬分校）。
- **學生列表**：符合條件的學生。
- **新增學生按鈕**。

**學生列表**：

- 每筆顯示：姓名、年級、學校、關聯家長、報名課程數、狀態。
- 點擊進入編輯或查看詳情。

**新增/編輯學生 Popup**：

| 欄位       | 類型     | 必填 | 說明             |
| ---------- | -------- | ---- | ---------------- |
| 姓名       | 文字     | 是   |                  |
| 年級       | 下拉選單 | 是   | 小一～高三、其他 |
| 就讀學校   | 文字     | 是   |                  |
| 生日       | 日期     | 否   |                  |
| 性別       | 單選     | 否   | 男/女/不透露     |
| 電話       | 文字     | 否   | 學生本人電話     |
| 地址       | 文字     | 否   |                  |
| 緊急聯絡人 | 文字     | 否   | 姓名+電話        |
| 備註       | 長文字   | 否   |                  |

**學生詳情頁**：

- 基本資料（可編輯）。
- 關聯家長列表。
- 報名的開課班列表（連結到學生報名頁面）。
- 出勤統計摘要。
- 成績統計摘要。

**家長管理頁面**：

管理家長帳號，關聯學生。

**頁面結構**：

- **篩選列**：姓名/手機/Email 搜尋、有無關聯學生。
- **家長列表**：符合條件的家長。
- **新增家長按鈕**。

**家長列表**：

- 每筆顯示：姓名、登入帳號（Email 或手機）、關聯學生數、帳號狀態。
- 點擊進入編輯或查看詳情。

**新增/編輯家長 Popup**：

| 欄位     | 類型   | 必填   | 說明                    |
| -------- | ------ | ------ | ----------------------- |
| 姓名     | 文字   | 是     |                         |
| Email    | 文字   | 二擇一 | 優先作為登入帳號        |
| 手機     | 文字   | 二擇一 | 無 Email 時作為登入帳號 |
| 關聯學生 | 多選   | 否     | 選擇要關聯的學生        |
| 帳號狀態 | 開關   | 是     | 啟用/停用               |
| 備註     | 長文字 | 否     |                         |

- Email 和手機至少填一個，有 Email 優先用 Email 當登入帳號。
- 系統自動判斷並顯示目前的登入帳號是 Email 或手機。

**關聯學生操作**：

- 在 Popup 中可搜尋並選擇學生。
- 支援關聯多個學生（多個小孩）。
- 關聯後，家長登入可看到這些學生的資料。

**帳號管理功能**：

在家長詳情頁面提供以下操作按鈕：

| 功能           | 說明                                     |
| -------------- | ---------------------------------------- |
| 重設密碼       | 產生新的隨機密碼，並產生新的帳號資訊卡   |
| 更換登入帳號   | 修改 Email 或手機，更換後自動重設密碼    |
| 產生帳號資訊卡 | 重新產生帳號資訊卡（含目前帳號和新密碼） |
| 停用帳號       | 暫停登入權限，資料保留                   |
| 啟用帳號       | 恢復登入權限                             |

**帳號異常處理流程**：

當家長無法登入時：

1. 家長致電補習班。
2. 管理員確認身份（核對學生姓名、關係、其他個資）。
3. 依情況處理：
   - **忘記密碼** → 點擊「重設密碼」，將新的帳號資訊卡交給家長。
   - **Email 無法使用** → 點擊「更換登入帳號」，輸入新 Email，交付新帳號資訊卡。
   - **手機換號且無 Email** → 點擊「更換登入帳號」，輸入新手機號，交付新帳號資訊卡。
4. 所有操作記錄於稽核紀錄。

**人員管理頁面**：

管理管理員、老師帳號。

**頁面結構**：

- **篩選列**：姓名搜尋、角色、服務分校。
- **人員列表**：符合條件的人員。
- **新增人員按鈕**。

**人員列表**：

- 每筆顯示：姓名、角色標籤、服務分校、電話、帳號狀態。
- 點擊進入編輯。

**新增/編輯人員 Popup**：

| 欄位     | 類型     | 必填     | 說明                          |
| -------- | -------- | -------- | ----------------------------- |
| 姓名     | 文字     | 是       |                               |
| 角色     | 下拉選單 | 是       | 管理員/老師              |
| 服務分校 | 多選     | 是       | 可選擇多個分校                |
| 教學科目 | 多選     | 老師必填 | 國文/英文/數學/自然/社會/其他 |
| 電話     | 文字     | 是       |                               |
| Email    | 文字     | 是       | 作為登入帳號                  |
| 生日     | 日期     | 否       |                               |
| 備註     | 長文字   | 否       |                               |
| 帳號狀態 | 開關     | 是       | 啟用/停用                     |

**角色說明**：

- **管理員**：可使用功能視 `admin_permissions` 而定。
- **權限設定**：建立帳號時可勾選該管理員的權限（如：管理人員、財務管理等）。
- **老師**：只能使用老師頁面功能（課表、聯絡簿、成績）。

**學生報名頁面**：

這是將學生加入開課班的關鍵功能，沒有報名就不會出現在課堂名單中。僅管理員可操作，避免繞過金流。

- **頁面結構**：左側學生選擇 + 右側報名管理。
- **手機版**：改為步驟式流程（選學生 → 選開課班 → 設日期 → 確認）。

**左側：學生選擇區塊**

- 學生搜尋框：依姓名搜尋。
- 學生列表：顯示姓名、年級、目前報名的開課班數。
- 點擊學生 → 右側顯示該學生的報名管理。

**右側：報名管理區塊**

- **學生基本資訊**：姓名、年級、就讀學校。
- **目前報名的開課班**：
  - 列表顯示已報名的開課班，每筆顯示：開課班名稱、課程名、生效起迄日期、狀態（進行中/已結束/未開始）。
  - 每筆可展開編輯生效日期或退出（標記結束日期）。
- **新增報名按鈕**：開啟新增報名 Popup。

**新增報名 Popup**：

1. 選擇開課班（可搜尋，顯示課程名+班名+上課時間摘要）。
2. 設定生效起始日期（預設今天）。
3. 設定生效結束日期（可留空，表示持續到學期結束）。
4. 確認新增。

**從試聽資料快速報名**：

在左側學生選擇區塊，新增「從試聽帶入」分頁：

- **搜尋學生**（預設分頁）：依姓名搜尋現有學生
- **從試聽帶入**：顯示「已完成」且「跟進結果=要報名」的試聽紀錄

選擇試聽紀錄後：

- 自動帶入學生資訊（若為新學生，先建立學生資料）
- 右側顯示該學生的報名管理
- 新增報名時自動帶入試聽的開課班
- 報名紀錄標記「來源：試聽轉報名」

**新學生處理流程**：

當報名時學生尚不存在於系統中，需要先建立學生資料：

1. **直接報名新學生**（搜尋學生分頁）：
   - 搜尋無結果時，顯示「找不到學生，新增學生」按鈕。
   - 點擊後開啟「新增學生 Popup」，填寫基本資料（姓名、年級、性別等）。
   - **必須同時建立家長**：新增學生時需填寫至少一位家長資料（姓名、Email 或手機）。
   - 若家長 Email 或手機已存在，顯示錯誤「此 Email／手機已被使用」，需改用其他聯絡方式或先找到該家長再關聯學生。
   - 儲存後自動選擇該學生，繼續報名流程。

2. **從試聽帶入新學生**：
   - 試聽紀錄中的學生姓名、年級會自動帶入。
   - 試聽紀錄中的家長資訊會自動帶入（姓名、手機、Email）。
   - 若家長 Email 或手機已存在，顯示錯誤「此 Email／手機已被使用」，需手動處理（修改聯絡方式或改用現有家長）。
   - 儲存成功後繼續報名流程。

3. **帳號建立時機**：
   - **家長帳號**：建立家長資料時自動建立帳號（有 Email 用 Email，無則用手機號）。
   - **預設密碼**：系統產生 6 位隨機代碼。
   - **首次登入**：強制修改密碼。

**帳號通知機制**：

- 家長帳號建立後，系統產生「帳號資訊卡」供列印或截圖。
- 卡片內容：補習班名稱、家長姓名、登入帳號（Email 或手機號）、預設密碼、登入網址、QR Code。
- 管理員可在「家長管理」頁面重新產生帳號資訊卡（用於密碼遺失或帳號變更）。
- 重新產生會重設密碼並產生新卡片。
- MVP 建議串接第三方 Email 服務以自動發送。若未串接，改由補習班人員列印或拍照給家長。

**批次報名功能**（方便開學大量處理）：

- 「批次報名」按鈕開啟批次模式。
- 選擇一個開課班 → 勾選多個學生 → 設定統一的生效日期 → 批次新增。

**試聽管理頁面**：

管理試聽申請，安排試聽時間，跟進試聽結果。

**頁面結構**：

- **分頁切換**：「待處理」「已安排」「已完成」「全部」
- **統計區塊**：各狀態數量、本月試聽數量

**試聽申請列表**：

每筆顯示：

- 家長姓名、手機
- 學生姓名、年級
- 想試聽的課程
- 申請時間
- 狀態標籤
- 安排的試聽日期（若已安排）

**待處理分頁操作**：

- 點擊申請 → 展開詳情 Popup
- 「安排試聽」按鈕：選擇試聽課堂、日期、填寫備註
- 「取消申請」按鈕：標記取消原因

**已安排分頁操作**：

- 顯示試聽日期倒數
- 「標記完成」按鈕：試聽結束後標記

**已完成分頁操作**：

- 「跟進」按鈕：填寫家長意願（要報名/不報名/考慮中）
- 若選擇不報名：填寫原因

**試聽詳情 Popup**：

- 家長資訊：姓名、手機
- 學生資訊：姓名、年級、學校
- 想試聽的課程
- 方便的時段
- 備註
- 安排的試聽課堂（若已安排）
- 試聽結果（若已完成）
- 狀態時間軸
- 若需取消，請電話聯繫補習班，由管理員代為取消（不提供家長自助取消）

**費用方案管理頁面**：

設定各開課班的收費標準，方便快速建立繳費單。

**頁面結構**：

- **篩選列**：課程、開課班、繳費週期、狀態
- 以開課班分組顯示費用方案
- 每個開課班可有多個費用方案（月繳方案、期繳方案、不同學期等）

**費用方案列表**：

- 每筆顯示：方案名稱、關聯開課班、**繳費週期標籤**、金額、生效期間、狀態（生效中/已過期/未開始）
- 繳費週期以標籤區分：「月繳」藍色、「期繳」綠色

**新增/編輯費用方案 Popup**：

| 欄位       | 類型     | 必填 | 說明                                   |
| ---------- | -------- | ---- | -------------------------------------- |
| 關聯開課班 | 下拉選單 | 是   | 選擇開課班                             |
| 方案名稱   | 文字     | 是   | 例如：國一數學 A 班 - 2026春季（月繳） |
| 繳費週期   | 單選     | 是   | 月繳 / 期繳                          |
| 金額       | 數字     | 是   | 月繳填月費，期繳填總額               |
| 生效期間   | 日期範圍 | 是   | 起始日、結束日                         |
| 按比例計算 | 開關     | 否   | 期繳專用，學期中加入時按比例計算     |
| 說明       | 文字     | 否   | 如「含教材費」                         |

**繳費週期說明**：

- **月繳**：每月收費，續課確認於每月 20 號發送
- **期繳**：一學期收費，續課確認於 1/15、7/15 發送
- 報名審核時選擇費用方案，繳費週期會記錄在學生的報名紀錄上
- 續課系統依報名紀錄的週期決定發送時間

**報名審核頁面**：

審核家長提交的報名申請，建立繳費單。

**頁面結構**：

- **操作列**：「從試聽建立」按鈕
- **分頁切換**：「待審核」「待付款」「已完成」「全部」
- **統計區塊**：各狀態數量、本月已完成數量

**從試聽建立報名**：

點擊「從試聽建立」按鈕後，開啟選擇 Popup：

- 顯示「已完成」且「跟進結果=要報名」的試聽紀錄
- 可搜尋學生姓名、家長姓名
- 每筆顯示：學生、家長、試聽課程、試聽日期
- 選擇後自動帶入家長、學生、試聽的開課班資訊
- 確認後建立報名申請，進入待審核流程

建立的報名申請會標記「來源：試聽轉報名」，可追溯原試聽紀錄。

**待審核分頁**：

- 顯示所有待審核的報名申請
- 按提交時間排序（最早在上，先進先審）
- 每筆顯示：
  - 學生姓名、家長姓名、手機
  - 想報名的開課班
  - 提交時間
  - 「處理」按鈕

**審核 Popup**：

點擊「處理」後開啟：

- 申請詳情：
  - 家長資訊：姓名、手機、Email
  - 學生資訊：姓名、年級、學校
  - 想報名的開課班（可能多個）
  - 備註
- 開課班資訊：上課時間、目前人數、費用方案
- 操作按鈕：
  - 「通過，建立繳費單」：開啟費用方案選擇
  - 「拒絕」：填寫拒絕原因

**費用方案選擇（建立繳費單時）**：

- **預設篩選**：自動篩選該開課班、目前生效中的方案
- **篩選功能**：可依繳費週期（月繳/期繳）、生效期間篩選
- **搜尋功能**：可依方案名稱搜尋
- **方案列表**：顯示方案名稱、繳費週期標籤、金額
- **選擇後**：金額自動帶入，可手動調整（如學期中加入按比例計算）
- **確認建立**：產生繳費單，進入待付款狀態

**待付款分頁**：

- 顯示已建立繳費單、等待付款的申請
- 每筆顯示：學生、開課班、金額、繳費期限、剩餘天數
- 即將到期（3 天內）：以紅色標記
- 已過期：以灰色顯示，可重新啟用（延長期限）

**已完成分頁**：

- 顯示已完成繳費的報名申請
- 可搜尋、篩選日期範圍

**繳費管理頁面**：

管理所有繳費單，確認收款。

**頁面結構**：

- **分頁切換**：「待確認」「全部」
- **統計區塊**：
  - 待確認收款數量
  - 本月收款總額
  - 本月待收總額

**待確認分頁**：

顯示已付款但尚未確認的繳費單（家長已通知付款，等待確認）。

- 每筆顯示：繳費單編號、學生、金額、繳費期限
- 點擊開啟「確認收款 Popup」

**全部分頁**：

顯示所有繳費單，可篩選：

- 狀態（待付款/已付款/已取消）
- 學生姓名
- 開課班
- 日期範圍

**繳費單列表**：

- 每筆顯示：繳費單編號、學生、開課班、金額、狀態、建立日期
- 狀態以顏色標籤區分
- 點擊開啟詳情/操作 Popup

**確認收款 Popup**：

- 繳費單資訊：編號、學生、金額
- 付款方式選擇：現金/銀行轉帳
- 付款日期（預設今天）
- 備註（如轉帳帳號末五碼）
- 「確認收款」按鈕

確認後：

- 繳費單狀態改為「已付款」
- 對應的報名申請狀態改為「已完成」
- 系統自動建立正式報名紀錄（Enrollment）
- 發送通知給家長

**繳費單詳情 Popup**：

- 基本資訊：編號、學生、開課班
- 費用明細
- 狀態與時間軸
- 關聯的報名申請
- 若已付款：付款資訊（日期、方式、確認人）
- 操作按鈕（依狀態）：
  - 待付款：確認收款、取消繳費單
  - 已付款：無操作

**待處理工作頁面**：

管理員查看、認領、處理各類工作任務。

**頁面結構**：

- **分頁切換**：「待認領」「我的任務」「已完成」「全部」
- **統計區塊**：各狀態數量、今日完成數量

**任務列表**：

每筆任務顯示：

- 任務類型圖標與標籤（報名審核/繳費確認/試聽跟進）
- 關聯對象摘要（學生姓名、家長姓名）
- 優先級標籤（高優先級以紅色標示）
- 截止日期（已逾期以紅色標示）
- 認領者（若已認領）
- 建立時間

**篩選功能**：

- 任務類型
- 優先級
- 截止日期範圍

**任務卡片操作**：

| 任務狀態         | 可用操作                             |
| ---------------- | ------------------------------------ |
| 待認領           | 認領                                 |
| 處理中（自己的） | 前往處理、轉派（僅管理員）、放棄認領 |
| 處理中（他人的） | 無操作（僅查看）                     |
| 已完成           | 查看詳情                             |

**認領流程**：

1. 點擊「認領」按鈕
2. 任務狀態變為「處理中」，認領者設為當前使用者
3. 任務移至「我的任務」分頁

**轉派流程**（需有 `view_tasks` 權限）：

1. 點擊「轉派」按鈕
2. 彈出選擇視窗，列出同分校的其他管理員
3. 選擇轉派對象，確認
4. 任務認領者變更為新對象

**前往處理**：

點擊「前往處理」後，依任務類型導向對應頁面：

- 試聽安排 → 試聽管理頁面，直接展開該申請
- 試聽跟進 → 試聽管理頁面，直接展開該申請
- 報名審核 → 報名審核頁面，直接展開該申請
- 繳費確認 → 繳費管理頁面，直接展開該繳費單
- 續課跟進 → 續課管理頁面，直接展開該確認

**任務完成機制**：

任務不需要手動標記完成，當關聯的業務操作完成時自動標記：

- 試聽安排任務：當試聽申請狀態變更為「已安排」或「已取消」時完成
- 試聽跟進任務：當試聽申請狀態變更為「已完成」時完成
- 報名審核任務：當報名申請狀態變更（通過/拒絕/取消）時完成
- 繳費確認任務：當繳費單確認收款時完成
- 續課跟進任務：當續課確認狀態變更（已確認/不續課）時完成

**系統設定頁面**：

管理系統全域設定，僅管理員可操作。

**頁面結構**：

以區塊分組顯示各類設定。

**科目管理區塊**：

管理補習班可使用的教學科目，用於課程分類和老師專長設定。

| 預設科目 | 備註     |
| -------- | -------- |
| 國語     | 國小     |
| 國文     | 國中以上 |
| 英文     |          |
| 數學     |          |
| 自然     | 國小     |
| 理化     | 國中     |
| 社會     |          |
| 其他     | 彈性使用 |

**操作**：

- 檢視模式：顯示所有科目標籤。
- 編輯模式：可新增、刪除、排序科目。
- 刪除限制：若科目已被課程或老師使用，不可刪除（顯示提示）。

**報名流程設定區塊**：

| 設定項目         | 輸入類型 | 說明                                 |
| ---------------- | -------- | ------------------------------------ |
| 報名審核處理時效 | 數字輸入 | 新申請應在幾天內完成審核（預設 3）   |
| 試聽跟進啟動天數 | 數字輸入 | 試聽結束後幾天產生跟進任務（預設 1） |

**繳費設定區塊**：

| 設定項目       | 輸入類型 | 說明                             |
| -------------- | -------- | -------------------------------- |
| 預設繳費期限   | 數字輸入 | 建立繳費單時的預設天數（預設 7） |
| 繳費到期前提醒 | 數字輸入 | 期限前幾天提醒家長（預設 3）     |

**續課設定區塊**：

| 設定項目       | 輸入類型 | 說明                                      |
| -------------- | -------- | ----------------------------------------- |
| 月繳發送日期   | 數字輸入 | 每月幾號發送續課確認（預設 20）           |
| 期繳發送日期 | 文字輸入 | 固定日期清單，逗號分隔（預設 1/15, 7/15） |
| 續課確認期限   | 數字輸入 | 發送後幾天內需確認（預設 7）              |

**補習班資訊區塊**：

| 設定項目   | 輸入類型 | 說明                       |
| ---------- | -------- | -------------------------- |
| 補習班名稱 | 文字輸入 | 顯示在報名表單標題         |
| 聯絡電話   | 文字輸入 | 顯示在報名成功頁、繳費通知 |
| 銀行戶名   | 文字輸入 | 轉帳用                     |
| 銀行名稱   | 文字輸入 | 轉帳用                     |
| 銀行帳號   | 文字輸入 | 轉帳用                     |

**儲存機制**：

- 每個區塊獨立儲存按鈕
- 修改後即時生效
- 記錄修改歷史（誰、何時、改了什麼）

**續課管理頁面**：

管理續課確認的發送狀態，追蹤家長回覆情況。

**頁面結構**：

- **分頁切換**：「待確認」「已確認」「已逾期」「全部」
- **統計區塊**：各狀態數量、本期確認率
- **篩選列**：繳費週期（全部/月繳/期繳）、適用期間

**續課確認列表**：

每筆顯示：

- 家長姓名
- 學生姓名
- 繳費週期標籤（月繳/期繳）
- 適用期間
- 狀態標籤
- 截止日期（待確認時顯示倒數天數）
- 確認時間（已確認時）

**列表操作**：

| 狀態   | 可用操作                       |
| ------ | ------------------------------ |
| 待確認 | 查看詳情、發送提醒、代為確認   |
| 已確認 | 查看詳情                       |
| 已逾期 | 查看詳情、代為確認、標記不續課 |

**續課確認詳情 Popup**：

- 家長/學生資訊
- 適用期間
- 狀態與時間軸
- 課程清單：
  - 目前報名的課程（顯示續課或退選）
  - 加選的課程（若有）
- 產生的繳費單連結（若已確認）
- 產生的報名申請連結（若有加選）

**代為確認功能**：

當家長無法自行操作時，管理員可代為確認：

1. 點擊「代為確認」
2. 勾選要續課的課程
3. 輸入備註（如「電話確認」）
4. 確認送出

**手動發送續課確認**：

除了系統自動發送外，管理員可手動發送：

- 「新增續課確認」按鈕
- 選擇繳費週期、適用期間
- 選擇要發送的家長（可批次勾選）
- 發送

---

## 8. 業務規則

### 8.1 不可違反的核心規則

1. **課堂是核心**：出勤、請假、聯絡簿都必須依附在課堂上。
2. **課堂不可刪除**：只能標記停課，保留歷史。
3. **人工優先**：人工修改的出勤狀態優先於系統推算，系統不會覆蓋人工修改。
4. **留痕**：重要操作都要記錄誰、什麼時候、做了什麼。

### 8.2 稽核紀錄要求

以下操作必須記錄**操作者、操作時間、操作內容**：

| 操作類型       | 記錄內容                                           | 顯示位置                        |
| -------------- | -------------------------------------------------- | ------------------------------- |
| 報名申請審核   | 審核者、審核時間、審核結果（通過/拒絕）、拒絕原因  | 報名申請詳情 Popup              |
| 繳費單建立     | 建立者、建立時間、金額、選擇的費用方案             | 繳費單詳情 Popup                |
| 繳費單調整     | 調整者、調整時間、調整前金額、調整後金額、調整原因 | 繳費單詳情 Popup                |
| 確認收款       | 確認者、確認時間、付款方式、付款日期               | 繳費單詳情 Popup                |
| 出勤修改       | 修改者、修改時間、修改前狀態、修改後狀態           | 課堂詳情 Popup                  |
| 請假建立       | 建立者、建立時間、請假原因                         | 請假詳情                        |
| 試聽安排       | 安排者、安排時間、安排的課堂                       | 試聽詳情 Popup                  |
| 試聽跟進       | 跟進者、跟進時間、跟進結果                         | 試聽詳情 Popup                  |
| 從試聽建立報名 | 建立者、建立時間、關聯的試聽編號                   | 報名申請詳情 Popup              |
| 續課代為確認   | 確認者、確認時間、備註                             | 續課確認詳情 Popup              |
| 課務異動       | 建立者、建立時間、異動類型、異動原因               | 課務異動詳情                    |
| 直接報名       | 建立者、建立時間、開課班、生效日期                 | 學生詳情頁                      |
| 學生資料修改   | 修改者、修改時間、修改欄位、修改前後值             | 學生詳情頁                      |
| 家長資料修改   | 修改者、修改時間、修改欄位、修改前後值             | 家長詳情 Popup                  |
| 帳號建立       | 建立者、建立時間、帳號角色                         | 人員詳情 Popup / 家長詳情 Popup |
| 帳號停用/啟用  | 操作者、操作時間、狀態變更                         | 人員詳情 Popup / 家長詳情 Popup |
| 密碼重設       | 操作者、操作時間                                   | 人員詳情 Popup / 家長詳情 Popup |
| 系統設定修改   | 修改者、修改時間、修改項目、修改前後值             | 系統設定頁面底部                |

**UI 呈現方式**：

在各詳情 Popup 底部顯示可收合的「操作紀錄」區塊：

```
├─────────────────────────────────────────────┤
│ ▼ 操作紀錄                                  │
│ ─────────────────────────────────────────── │
│ 2/5 14:30  李管理員  確認收款（現金）         │
│ 2/3 10:15  李管理員  建立繳費單 $18,000       │
│ 2/2 09:30  張管理員  審核通過                 │
│ 2/1 08:00  系統    收到報名申請             │
└─────────────────────────────────────────────┘
```

- **位置**：詳情 Popup 底部，預設收合
- **排序**：按時間倒序（最新在上）
- **格式**：`[日期時間] [操作者] [操作摘要]`
- **系統操作**：操作者顯示「系統」
- **時間篩選**：提供時間區間篩選（預設顯示近 30 天，可調整）
- **分頁**：紀錄超過 20 筆時分頁顯示

**出勤修改的特殊處理**：

出勤是以學生為單位，採用「學生標記 + 底部紀錄」的結合方式：

```
課堂詳情 Popup - 出勤名單
─────────────────────────────────────────────
│ 王小明  [出席]                             │
│ 李小華  [請假] ✎                           │  ← ✎ 表示有人工修改
│ 陳大文  [遲到] ✎                           │
├─────────────────────────────────────────────┤
│ ▼ 出勤修改紀錄                              │
│ ─────────────────────────────────────────── │
│ 2/5 10:30  李管理員  李小華：缺席 → 請假      │
│ 2/5 10:25  李管理員  陳大文：出席 → 遲到      │
└─────────────────────────────────────────────┘
```

- 被修改過的學生，出勤狀態旁顯示 ✎ 標記
- 點擊 ✎ 可快速查看該學生的修改紀錄
- 底部區塊顯示該課堂所有出勤修改紀錄

### 8.3 到班與出勤規則

**出勤模式影響行為**：

- **日到班模式**（預設）：學生打卡到班後，系統自動將當天所有課堂標記為出席。
- **課堂模式**：學生打卡只記錄到班時間，出勤需由管理員或任課老師逐堂確認。

**通用規則**：

1. 學生到班後，系統行為依分校設定的出勤模式而定。
2. 「有報名」= 學生報名了該開課班，且今天在生效期間內。
3. 如果課堂已被人工修改過出勤，系統推算不會覆蓋。
4. 如果課堂結束後沒有任何出勤紀錄，系統自動標記為缺席。

**出勤修改權限**：

- 管理員：可修改所有課堂的出勤，不限時間。
- 老師：只能修改自己任課課堂的出勤，**僅限當天**。過期的出勤修改需找管理員處理。

### 8.4 請假規則

1. 請假只能由管理員建立。
2. 允許事後補請。
3. 請假會將出席狀態改為「請假」。

### 8.5 考試與成績規則

**考試事件建立**：

1. 考試事件必須指定課程歸屬（用於分類）。
2. 課堂關聯為可選：
   - 有關聯：小考，在特定課堂中進行。
   - 無關聯：獨立考試（模擬考），需指定考試日期。
3. 建立考試時需指定「參加範圍」，以開課班為單位選擇。

**參加範圍選擇 UI**：

- 樹狀結構多選，按課程分組顯示開課班。
- 勾選課程自動勾選該課程所有開課班。
- 顯示每個開課班的學生人數。
- 底部顯示已選總人數。
- 支援搜尋開課班。

**參加範圍邏輯**：

- 若有關聯課堂：預設該課堂所屬開課班的學生，可手動加其他班。
- 若無關聯課堂：必須手動選擇參加範圍。
- 輸入成績時可臨時加入其他學生（處理跨課程參加的情況）。

**成績輸入**：

1. 成績屬於考試事件，不直接屬於課堂。
2. 預設顯示參加範圍內的學生名單。
3. 可臨時加入其他學生輸入成績。
4. 預期參加但未輸入分數者，可標記為「缺考」。
5. 缺考不計入平均。

**權限**：

- 老師：只能建立/輸入自己任課班級的考試和成績。
- 管理員：可建立/輸入所有考試和成績。

### 8.6 通知規則

**課務異動通知**：

1. 調課/代課/停課時，自動發送通知給：
   - 該課堂的任課老師
   - 該課堂學生的家長

**任務相關通知**：

| 事件         | 通知對象             | 通知內容                                        |
| ------------ | -------------------- | ----------------------------------------------- |
| 新任務產生   | 同分校的管理員       | 「有新的[任務類型]待處理：[關聯對象]」          |
| 任務被認領   | 同團隊成員           | 「[認領者] 已認領 [任務類型]：[關聯對象]」      |
| 任務被轉派   | 被轉派者             | 「[轉派者] 將 [任務類型] 轉派給您：[關聯對象]」 |
| 下屬完成任務 | 該下屬的上司         | 「[下屬姓名] 已完成 [任務類型]：[關聯對象]」    |

**續課相關通知**：

| 事件         | 通知對象     | 通知內容                                               |
| ------------ | ------------ | ------------------------------------------------------ |
| 續課確認發送 | 家長         | 「請確認 [學生姓名] 的 [期間] 續課，截止日期：[日期]」 |
| 續課確認提醒 | 家長         | 「[學生姓名] 的續課確認即將截止（[剩餘天數] 天）」     |
| 續課確認完成 | 管理員       | 「[家長姓名] 已確認 [學生姓名] 的續課」                |
| 續課確認逾期 | 管理員       | 「[學生姓名] 的續課確認已逾期，請跟進」                |

**通知一般規則**：

1. 通知保留 90 天。
2. MVP 站內通知 + 推播（僅關鍵事件：續課預告/繳費通知/課務異動）。
3. 首次開啟家長/老師/管理員端時請求推播授權，可在設定中關閉。

### 8.7 課務異動顯示規則

課務異動（調課/代課/停課）在課表和首頁的顯示方式：

**調課**：

- 原日期課堂：顯示卡片，灰底/半透明，標籤「已調課→[新日期]」。
- 新日期課堂：顯示卡片，正常底色，標籤「調課自 [原日期]」。
- 點擊任一卡片的 Popup 中顯示完整調課資訊（原日期、新日期、原因）。

**代課**：

- 課堂卡片正常顯示，標籤「代課」。
- Popup 中顯示原任課老師與代課老師。

**停課**：

- 課堂卡片灰底 + 文字刪除線，標籤「已停課」。
- Popup 中顯示停課原因。

**視覺標記摘要**：

| 異動類型       | 卡片樣式      | 標籤文字      |
| -------------- | ------------- | ------------- |
| 調課（原課堂） | 灰底/半透明   | 已調課→[日期] |
| 調課（新課堂） | 正常底色      | 調課自 [日期] |
| 代課           | 正常底色      | 代課          |
| 停課           | 灰底 + 刪除線 | 已停課        |

此規則適用於：家長首頁課表、課表查看頁、到班紀錄頁的課堂列表。

### 8.8 試聽申請規則

**試聽與報名分離**：

試聽申請與報名申請流程獨立。家長試聽後若決定報名，需另外填寫報名申請表單（系統可關聯試聽來源）。

**試聽申請流程**：

1. 家長提交試聽申請後，狀態為「待處理」，系統產生「試聽安排」任務
2. 管理員認領任務，電話聯繫家長，安排試聽時間，狀態改為「已安排」
3. 學生到班試聽，試聽完成後狀態改為「已完成」
4. 系統產生「試聽跟進」任務，管理員電話跟進了解家長意願
5. 若家長決定報名，請家長自行填寫報名申請表單（`/apply`）

**試聽任務與通知規則**：

| 事件       | 系統動作             | 通知對象     | 說明                       |
| ---------- | -------------------- | ------------ | -------------------------- |
| 新試聽申請 | 產生「試聽安排」任務 | 管理員       | 管理員認領後聯繫家長安排試聽 |
| 安排試聽   | 更新申請狀態         | 家長（電話） | 人工通知試聽時間、地點     |
| 試聽完成   | 產生「試聽跟進」任務 | 管理員       | 管理員認領後電話跟進確認意願 |

**試聽當日流程**：

- 試聽生到班時由櫃檯管理員接待。
- **不需要**進行掃碼簽到。
- 試聽生**不會**出現在老師的常規 APP 點名表中（或由管理員口頭告知老師）。

### 8.9 報名與繳費規則

**報名申請流程**：

1. 家長提交報名申請後，狀態為「待審核」
2. 管理者審核通過後，**依據申請單建立繳費單**，並自動建立報名紀錄 (Enrollment)，狀態為「待繳費 (Pending Payment)」。申請狀態改為「待付款」。
3. 家長完成付款（含部分繳費），通知補習班
4. 管理者確認收款後：
   - 繳費單狀態更新（部分繳費或已繳清）
   - 若為首次繳費（含部分繳費），系統**自動建立家長帳號和學生資料**（若尚未建立）
   - 報名申請狀態改為「已完成」（若已繳清）或保持追蹤
   - 報名紀錄 (Enrollment) 狀態更新為「活躍 (Active)」


**繳費週期**：

- 報名時可選擇繳費週期：月繳或期繳
- 同一個學生的不同課程可以有不同繳費週期
- 繳費週期影響後續續課確認的發送時機

**繳費狀態定義**：

- **待付款 (Pending)**：剛建立，等待家長繳費。
- **部分繳費 (Partial)**：家長已付訂金或部分款項。視為**有效報名**，學生可正常入班上課，且不受寬限期限制（不會因逾期而失效）。系統會提示餘額。
- **已繳清 (Paid)**：全額繳清。
- **逾期 (Overdue)**：超過繳費期限，但仍在寬限期內。家長/管理員會看到催繳警示，但學生**權限不受影響**（可正常出勤）。
- **已失效 (Void)**：超過繳費期限 + 寬限期。報名失效，學生無法入班/點名，需管理員人工介入處理（重啟或釋出名額）。
- **已退款 (Refunded)**：已付款但後續因故退費。對應的報名狀態需變更為「退選 (Withdrawal)」，且學生權限將被撤銷。

**繳費期限與寬限期規則**：

- 審核通過時設定繳費期限（預設 7 天）。
- 寬限期（Grace Period）：設定為 X 天（系統設定，預設 7 天）。
- 流程：正常 -> 逾期（Overdue, 仍可上課）-> 失效（Void, 鎖權限）。
- 已失效的申請可由管理者重新啟用（延長繳費期限）。

**費用計算規則**：

- 系統依費用方案自動計算應繳金額
- 學期中加入：若費用方案設定支援按比例計算，系統依剩餘課堂數計算
- 管理者可在審核時調整金額（需填寫原因，如早鳥優惠、兄弟姊妹折扣）

**直接報名（管理者）**：

- 管理者可跳過申請流程，直接將學生加入開課班
- 可選擇繳費週期和是否同時建立繳費單
- 適用於現場報名、老學生加報、特殊情況等

**報名通知規則**：

| 事件                      | 通知對象     | 通知方式   | 通知內容                             |
| ------------------------- | ------------ | ---------- | ------------------------------------ |
| 新報名申請                | 管理者       | 站內       | 有新的報名申請待審核                 |
| 建立繳費單                | 家長         | 電話/email | 繳費金額、期限、付款方式（人工通知） |
| 報名申請被拒絕            | 家長         | 電話       | 拒絕原因（人工通知）                 |
| 繳費期限即將到期（3天前） | 管理員       | 站內       | 「XXX 繳費單即將到期，請跟進」       |
| 繳費完成                  | 家長         | email      | 帳號密碼、登入網址、報名成功確認（需第三方服務） |
| 申請已過期                | 管理者       | 站內       | 「XXX 繳費單已過期」                 |

### 8.10 續課規則（預告制）

**關鍵時程**：

| 繳費週期 | 預告日(T-5) | 開單日(T-0) | 備註 |
| -------- | ---------- | ---------- | ---- |
| 月繳     | 每月 15 號 | 每月 20 號 | 7 天後截止 |
| 期繳     | 1/10、7/10 | 1/15、7/15 | 7 天後截止 |

**續課邏輯（Pre-Notification Auto-Renewal）**：

1.  **自動路徑判定**：
    -   系統依據 `classes.next_class_id` 決定續課目標班級。
    -   若無下一階班級，預設續報原班級。

2.  **異動申請優先**：
    -   在開單日當天，系統會先檢查該學生是否有 **「未結案的續課異動任務」**。
    -   若有，**跳過自動開單**，交由管理員人工處理。
    -   若無，則視為同意續課，自動產生繳費單。

3.  **自動失效 (Auto-Void)**：
    -   **條件**：`繳費單逾期` AND `超過寬限期 (Grace Period)`。
    -   **動作**：
        -   將繳費單狀態設為 `void`。
        -   將該生新的 Enrollment 狀態設為 `void` 或 `suspended`。
        -   停止該生的到班權限。
    -   **目的**：清除未續課的幽靈名單，無需管理員手動清理。

**續課通知規則**：

| 事件 | 通知對象 | 通知內容 |
| ---- | ---- | ---- |
| 續課預告 (T-5) | 家長 | 下期帳單將於 5 天後開立，若需變更請點此申請。 |
| 繳費單開立 (T-0) | 家長 | 繳費單已產生，請於期限內繳費。 |
| 繳費逾期提醒 | 家長 | 您的繳費單已逾期，請盡速繳費以免影響上課權益。 |
| 自動失效通知 | 家長 | 您的報名已因逾期未繳而自動取消。如需復學請聯繫管理員。 |

**人工介入時機**：

1.  收到家長提交的「異動申請」任務時。
2.  家長錯過所有通知，導致被「自動失效」，打電話來要求復學時（管理員手動重啟繳費單）。

### 8.11 密碼管理規則

**密碼強度要求**：
- 最小長度：6 字元
- 允許字元：英文大小寫、數字、特殊符號
- 強制性：不強制要求大小寫混合（考慮家長與學生的易用性）

**密碼重設功能**：

管理員可將帳號密碼重設為**系統隨機生成的 6 位數代碼**：

| 操作者 | 可重設對象       |
| ------ | ---------------- |
| 擁有管理人員權限的管理員 | 其他管理員、老師、家長 |
| 一般權限管理員 | 家長             |
| 老師   | -                |
| 家長   | -                |

- 管理者不能重設其他管理者的密碼（避免互鎖）。
- 管理者自己忘記密碼需聯繫系統管理員處理。
- 重設後該帳號下次登入**強制修改密碼**。
- 所有重設操作記錄於稽核紀錄。

**自行修改密碼**：

所有角色登入後可在「個人設定」修改自己的密碼：

- 需輸入現有密碼驗證身份
- 新密碼需輸入兩次確認
- 密碼長度至少 6 位

**忘記密碼處理**：

MVP 不提供線上忘記密碼功能，統一走人工處理：

1. 使用者致電補習班
2. 管理員確認身份後，在系統中重設密碼
3. 系統產生一組隨機 6 位數代碼（僅顯示一次），管理員需透過**口頭告知或線下紙本**等安全方式傳遞給使用者
4. 使用者下次登入時強制修改密碼

**登入頁面**：

- 不顯示「忘記密碼」連結
- 顯示補習班聯絡電話，引導使用者致電處理

---

## 9. 數據管理

本章節定義各類數據的保留策略，確保系統長期運作時資料庫不會無限膨脹。

### 9.1 數據分類

系統數據依重要性和生命週期分為三類：

| 分類     | 說明                     | 處理方式       |
| -------- | ------------------------ | -------------- |
| 核心數據 | 業務運作必要的永久資料   | 永久保留       |
| 流程數據 | 完成後僅供查詢的歷史資料 | 歸檔後定期清理 |
| 日誌數據 | 臨時性的追蹤紀錄         | 定期清理       |

### 9.2 保留期限

#### 核心數據（永久保留）

| 數據類型                   | 說明                              |
| -------------------------- | --------------------------------- |
| 分校（Campus）             | 組織架構                          |
| 課程（Course）             | 課程定義                          |
| 開課班（Class）            | 班級定義                          |
| 學生（Student）            | 學生資料，除非明確要求刪除        |
| 家長（Parent）             | 家長帳號，除非明確要求刪除        |
| 老師/管理員（Staff）         | 人員帳號                          |
| 報名記錄（Enrollment）     | 學籍核心資料                      |
| 繳費紀錄（Payment Record） | 財務資料，依法規可能需保留 5-7 年 |
| 成績紀錄（Grade）          | 學業數據                          |
| 費用方案（Fee Template）   | 收費標準定義                      |

#### 流程數據（歸檔後清理）

| 數據類型                         | 保留期限      | 說明                        |
| -------------------------------- | ------------- | --------------------------- |
| 試聽申請（Trial Request）        | 完成後 1 年   | 完成 = 已完成或已取消       |
| 報名申請（Enrollment Request）   | 結案後 1 年   | 完成/拒絕/取消/過期皆視為結案 |

| 繳費單（Invoice）                | 完成後 7 年   | 配合財務法規（與繳費紀錄一致）|
| 待處理任務（Task）               | 結案後 6 個月 | 完成/取消皆視為結案        |

#### 日誌數據（定期清理）

| 數據類型                | 保留期限           | 說明                      |
| ----------------------- | ------------------ | ------------------------- |
| 到班紀錄（Check-in）    | 2 年               | 出勤統計需要              |
| 課堂出勤（Attendance）  | 2 年               | 出勤統計需要              |
| 通知（Notification）    | 90 天              | 過期通知無查閱價值        |
| 稽核紀錄（Audit Log）   | 2 年               | 操作追蹤與安全稽核        |
| 課堂（Session）         | 永久，但歸檔舊學期 | 超過 2 年的課堂標記為歸檔 |
| 請假紀錄（Leave）       | 2 年               | 出勤相關                  |
| 餐費紀錄（Meal Record） | 2 年               | 帳務相關                  |
| 聯絡簿（Teacher Log）   | 2 年               | 歷史紀錄                  |

### 9.3 實作機制

#### 軟刪除與歸檔標記

可歸檔的資料表需包含以下欄位：

| 欄位          | 類型               | 說明                      |
| ------------- | ------------------ | ------------------------- |
| `archived_at` | datetime, nullable | 歸檔時間，NULL 表示未歸檔 |

- 查詢時預設只撈取 `archived_at IS NULL` 的資料
- 需要查詢歷史資料時，明確加入歸檔資料

#### 定期任務

系統需執行以下定期任務（建議每日凌晨執行）：

**1. 歸檔任務**

- 掃描各流程數據表
- 將超過保留期限的「已完成」資料設定 `archived_at = NOW()`

**2. 清理任務**

- 掃描各日誌數據表
- 刪除超過保留期限的資料
- 刪除已歸檔超過 1 年的流程數據（可選：先匯出備份）

**3. 備份任務**（可選）

- 清理前將資料匯出為 JSON/CSV
- 存放至雲端儲存（如 S3）供日後查詢

### 9.4 管理者介面

在系統設定中提供「數據管理」區塊：

**顯示資訊**：

- 各類數據的目前筆數
- 已歸檔數據筆數
- 上次清理時間

**操作功能**（MVP 可簡化）：

- 手動執行歸檔
- 匯出歸檔數據
- 查看清理日誌

---

## 10. 視覺風格指引

### 10.1 品牌調性

- 秩序、可信賴、整理、陪伴。
- 沉穩、俐落，偏「教務手冊」的感覺。

### 10.2 配色

請參閱 `DESIGN_GUIDELINE.md` 取得完整色彩規範。

- **主色調**：Zinc 灰階系統，搭配 Sky Blue 強調色。
- **功能色**：使用語意化色彩（Success/Warning/Error）標示狀態。

### 10.3 版面原則

- 以列表和表格為主。
- 狀態用「文字 + 色塊標籤」呈現，不只靠顏色。
- 動效輕微（淡入 + 微上移），不花俏。

### 10.4 導航設計

**桌面版**：側邊欄導航，顯示各功能入口。

**手機版**：底部導航 + Header。

**通知徽章**：

- 未讀通知數顯示在導航列的「通知中心」入口旁（紅色圓圈數字徽章）。
- 所有頁面都可見，不限於首頁。
- 點擊進入 `/parent/notifications`（家長）或 `/teacher/notifications`（老師）。

**家長孩子切換器**：

桌面版（側邊欄頂部）：

```
┌──────────────┐
│  [頭像]      │
│  小明        │
│  國一 · 台北校│
│  [切換孩子 ▼]│
├──────────────┤
│ 首頁         │
│ 到班紀錄     │
│ ...          │
```

手機版（Header）：

```
┌─────────────────────────────────────────┐
│ ≡  [頭像] 小明 ▼              [通知🔴] │
├─────────────────────────────────────────┤
```

- 點擊「頭像+名字」區塊展開下拉選單。
- 切換後整個頁面資料刷新。
- 名字過長時截斷顯示（例如：小明明... ▼）。

**切換/新增孩子下拉選單**：

```
┌─────────────────┐
│ ● 小明（國一）  │  ← 目前選擇
│ ○ 小華（國三）  │
│ ───────────────│
│ + 新增孩子      │
└─────────────────┘
```

**新增孩子 Popup**：

家長可在任何頁面新增孩子，方便為新孩子報名或試聽。

- **姓名**（必填）
- **年級**（必填，下拉選單）
- **就讀學校**（必填）

點擊「確認新增」後：

- 系統建立學生資料並關聯到家長帳號
- 自動切換到新孩子
- 頁面資料刷新為新孩子的資料

**管理員側邊欄**：

```
┌──────────────────┐
│ 📊 儀表板        │
│ 👥 學生管理      │
│ 👨‍👩‍👧 家長管理      │
│ 📚 課程管理      │
│ 📅 課程日曆      │
│ ▼ 出勤管理       │  ← 可收合
│    出勤歷史紀錄  │
│    請假管理      │
│ 🍽️ 餐費管理      │
│ 📝 成績查閱      │
│ 🔍 課堂搜尋      │
│ 📋 課務異動紀錄  │
│ ✅ 待處理工作    │
└──────────────────┘
```

- 「出勤管理」預設收合，點擊展開顯示子項目。
- 子項目縮排顯示，視覺上區分層級。
- 進入子頁面時，「出勤管理」自動展開並標記當前頁面。

### 10.5 Popup 設計原則

系統中多處使用 Popup 呈現詳情（課堂詳情、聯絡簿詳情等），需遵守以下原則：

**桌面版**：

- 寬版 Popup（max-width: 640px 或更寬），資訊不要擠在一起。
- 資訊分區塊呈現，區塊之間留白適當。
- 若內容多，使用垂直捲動，不要擠成一團。

**手機版**：

- Popup 改為全螢幕或近全螢幕的 Bottom Sheet / Modal。
- 資訊分頁籤（Tabs）或折疊區塊（Accordion）呈現，避免一次顯示太多。
- 優先顯示最重要的資訊（基本資訊、出勤狀態），其他可收合。

**共通原則**：

- 關閉按鈕明顯易點。
- 重要操作按鈕（如儲存、確認）固定在底部。
- 載入中狀態要有 Skeleton 或 Spinner。

### 10.6 響應式設計原則

**斷點定義**：

- 手機：< 768px
- 平板：768px - 1024px
- 桌面：> 1024px

**手機版調整**：

- 卡片 Grid 改為單欄垂直排列。
- 表格改為卡片列表或可橫向捲動。
- 側邊欄改為底部導航或漢堡選單。
- 減少同時顯示的資訊量，使用「查看更多」展開。

**家長首頁手機版**：

- 今日到班狀態：保持原樣，佔用少量空間。
- 課表卡片：單欄排列，左右滑動切換日期。
- 聯絡簿輪播：保持輪播，一次顯示一張卡片。
- 課堂詳情 Popup：改為全螢幕 Modal，資訊分頁籤呈現。

---

## 11. 資料關聯圖

```
分校 (Campus)
  │
  ├── 課程 (Course)
  │     │
  │     └── 開課班 (Class)
  │           │
  │           ├── 上課時間 (Schedule) ─── 課堂 (Session)
  │           │     └── 任課老師              │
  │           │                              ├── 出勤 (Attendance)
  │           └── 學生報名 (Enrollment)      ├── 請假 (Leave)
  │                 └── 學生                  └── 聯絡簿 (Teacher Log)
  │
  └── 考試事件 (Assessment)
        │
        └── 成績 (Grade)
              └── 學生

人員帳號 (Profile)
  ├── 管理者
  ├── 管理員
  ├── 老師
  └── 家長 ─── 學生關聯 ─── 學生

學生 (Student)
  ├── 報名 → 開課班
  ├── 到班紀錄
  └── 餐費紀錄
```

---

## 12. 附錄：常見問題

### Q1：學生沒有出現在課堂名單中？

檢查：

1. 學生是否有報名該開課班？
2. 報名的生效日期是否包含該課堂的日期？

### Q2：學生到班後沒有自動標記出勤？

檢查：

1. 學生是否有報名今天有課的開課班？
2. 報名的生效日期是否包含今天？
3. 該課堂是否已被人工修改過？（人工優先，不會被覆蓋）

### Q3：家長看不到孩子的資訊？

檢查：

1. 家長帳號是否已和學生建立關聯？

---

## 13. 附錄：參考文件

本產品需求文件依賴以下附屬文件之詳細規範：

### 13.1 法律與合規
*   [隱私權政策 (Privacy Policy)](./PRIVACY_POLICY.md)
*   [使用條款 (Terms of Service)](./TERMS_OF_SERVICE.md)

### 13.2 補充規格
*   [續課 UI 流程 (Pre-Notification Auto-Renewal Supplement)](./RENEWAL_UI_FLOW.md)：第 8.10 節之詳細 UI 互動參考。
*   [線上金流規劃 (Future Payment Plan)](./future/PAYMENT_PLAN.md)：非本期 MVP 範圍，僅供未來架構參考。

---

## 文件狀態

- 版本：2.0
- 狀態：Draft
- 本文件為產品需求的最終定義，技術實作必須符合本文件。
